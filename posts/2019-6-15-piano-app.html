<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"/><link rel="manifest" href="/favicon/site.webmanifest"/><link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#ef4444"/><link rel="shortcut icon" href="/favicon/favicon.ico"/><meta name="msapplication-TileColor" content="#ef4444"/><meta name="msapplication-config" content="/favicon/browserconfig.xml"/><meta name="theme-color" content="#ef4444"/><meta property="og:type" content="website"/><meta property="og:title" content="Magicbell&#x27;s Website"/><meta property="og:url" content="https://imagicbell.github.io"/><meta property="og:description" content="Welcome to Magicbell&#x27;s Website, a place where you will know more about me from my professional experience and technical posts."/><meta property="og:image" content="/_next/static/images/avatar-b229a410146fdbebcd2035ef237d2ad0.jpg"/><title>A Simple Piano App Developed By Tonejs</title><meta name="description" content="Use React and Tonejs to develop a simple piano app."/><meta property="og:type" content="website"/><meta property="og:title" content="A Simple Piano App Developed By Tonejs"/><meta property="og:url" content="https://imagicbell.github.io/posts/2019-6-15-piano-app"/><meta property="og:description" content="Use React and Tonejs to develop a simple piano app."/><meta property="og:image" content="https://imagicbell.github.io/blog/assets/img-piano/1.jpg"/><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="A Simple Piano App Developed By Tonejs"/><meta name="twitter:description" content="Use React and Tonejs to develop a simple piano app."/><meta name="twitter:image" content="https://imagicbell.github.io/blog/assets/img-piano/1.jpg"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"/><script defer="" src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script><meta name="next-head-count" content="29"/><link rel="preload" href="/_next/static/css/555b173cbb3b3b45df80.css" as="style"/><link rel="stylesheet" href="/_next/static/css/555b173cbb3b3b45df80.css" data-n-g=""/><link rel="preload" href="/_next/static/css/1a68ae46e299420c5773.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1a68ae46e299420c5773.css" data-n-p=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-e903dbcb0f26f07bddca.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-245f049e565ebf942e09.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.29f9e2f3d4a33bafbaa5.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.449049b2eba38352d9f4.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-8c930b98cabfdb7a913b.js" as="script"/><link rel="preload" href="/_next/static/chunks/cb1608f2.16ad8215560a85b40620.js" as="script"/><link rel="preload" href="/_next/static/chunks/a9a7754c.dec6fcf45fa1bcf7c2c8.js" as="script"/><link rel="preload" href="/_next/static/chunks/eda77bfa782fcce19c31e9417d5ccf0cdb548971.d0a029473df3535a2906.js" as="script"/><link rel="preload" href="/_next/static/chunks/8410e8da63518be12bbb03b338cbeeeaa2b87d98.22e74b4b4510f82d44b7.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bslug%5D-3941c16fb34e6e40ffc2.js" as="script"/></head><body><div id="__next"><div class="min-h-screen"><div class="w-full bg-theme-bg-strong flex justify-between items-end px-container py-4 text-theme-bg-strong-text"><h2 class="text-xl md:text-3xl font-bold tracking-tighter md:tracking-tight"><a class="" href="/">Magicbell&#x27;s Website</a></h2><nav class="text-base md:text-lg flex justify-end items-center"><a class="border-b-2 border-theme-bg-strong-text border-opacity-0 hover:border-opacity-100 mx-2 md:mx-4" href="/blog">Blog</a><a class="border-b-2 border-theme-bg-strong-text border-opacity-0 hover:border-opacity-100 mx-2 md:mx-4" href="/resume">Resume</a></nav></div><main class="relative container mx-auto my-14 px-container"><div class="mx-auto"><article class="mb-20"><div class="max-w-4xl mx-auto mb-20"><h1 class="text-4xl md:text-5xl lg:text-6xl font-bold tracking-tighter leading-tight md:leading-none mb-6 text-center md:text-left">A Simple Piano App Developed By Tonejs</h1><div class="text-base text-theme-meta flex items-center"><time dateTime="2019-06-15T10:00:00+08:00">June	15, 2019</time><div class="w-px h-px border rounded mx-3 border-theme-meta"></div><span>5min read</span></div><hr class="border-theme-line mt-2"/></div><div class="max-w-3xl mx-auto"><div class="markdown-body markdown-styles_markdown__1x9gM"><h3 id="section-motivation">Motivation</h3>
<p>When I was pregnant, my husband bought me a piano, because he wanted us and our baby to learn piano together. Hmm… a good point:)</p>
<p>But I found it difficult to find a free app that teaches me how to play. Most of the sheet music that I love are in-app purchases. So I decided to make a simple app to help myself read sheet and play piano.</p>
<p><a href="https://github.com/imagicbell/piano-app" rel="noopener noreferrer" target="_blank">GitHub link</a>.</p>
<h3 id="section-a-glance">A Glance</h3>
<p><img loading="lazy" src="/blog/assets/img-piano/1.jpg" alt=""></p>
<p><img loading="lazy" src="/blog/assets/img-piano/2.jpg" alt=""></p>
<p>This is how it looks. </p>
<ul>
<li>The white and black keys on the piano can be clicked to play.</li>
<li>It supports two types of music files: MIDI and MusicXML. Also it outputs the parsed json content of the music files.</li>
<li>It provides a simple play control, including play, pause, resume, step forward and backward, as well as the playback speed.</li>
</ul>
<h3 id="section-deep-into-the-main-features">Deep Into The Main Features</h3>
<h4 id="section-1-the-keyboard-interface">1. The Keyboard Interface</h4>
<p>This little virtual keyboard is simply created by css styles, calculating the position and color of each key. Also bind the click event to each key with a unique identifier. </p>
<p>In addition, to fullfil autoplay, I use redux state. Connect the key states to the <code>activeKeys</code> in the redux store, which can be updated somewhere else, e.g. the midi player.</p>
<h4 id="section-2-read-music-sheet">2. Read Music Sheet</h4>
<p>We support two music file types: MIDI and MusicXML. Reading MIDI files can be simply done using <a href="https://github.com/Tonejs/Midi" rel="noopener noreferrer" target="_blank">tonejs/midi</a>, which provides api to load MIDI files into javascript object, so I can retrieve the information needed to play using Tonejs. </p>
<p>For MusicXML, I use <a href="https://github.com/jnetterf/musicxml-interfaces" rel="noopener noreferrer" target="_blank">musicxml-interfaces</a>, which helps me to parse alien sheet music into javascript object. The most difficult and time consuming part is then to extract and organise the information needed to play using Tonejs. I checked <a href="https://www.musicxml.com/tutorial/" rel="noopener noreferrer" target="_blank">musicxml docs</a> a lot for understanding what each element in the sheet music means. Maybe now there are many good works out there which can accomplish this task. If you are interested in the detailed implementation, you can reference the musicxml docs and dive deep into my code. I will ignore the illustration here, as it is really a long story.</p>
<h4 id="section-3-display-music-sheet">3. Display Music Sheet</h4>
<p>I use <a href="https://github.com/opensheetmusicdisplay/opensheetmusicdisplay" rel="noopener noreferrer" target="_blank">OpenSheetMusicDisplay</a> to render MusicXML sheet music, which is really a wonderful tool. The usage is quite simple. Call the constructor first, and then load the mxl file, which is a promise. Call render function when the promise resolves.</p>
<pre><code class="javascript language-javascript">componentDidMount() {
  this.osmd = new OpenSheetMusicDisplay("osmd");
}

componentWillReceiveProps(nextProps: MusicSheetProps) {
  if (!nextProps.content) {
    this.osmd.clear();
    return;
  }
  this.osmd.load(nextProps.content).then(
    () =&gt; {
      this.osmd.render()
    }, (e) =&gt; {
    console.log("music sheet load error\n", e);
  });
}</code></pre>
<h4 id="section-4-play-music">4. Play Music</h4>
<p>This is the part of playing with Tonejs. </p>
<h5 id="section-sound-generation">Sound Generation</h5>
<p>I chose <a href="https://tonejs.github.io/docs/Sampler.html" rel="noopener noreferrer" target="_blank">Tone.Sampler</a> to generate the piano sounds. I followed the code from <a href="https://github.com/nbrosowsky/tonejs-instruments" rel="noopener noreferrer" target="_blank">tonejs-instruments</a> and only generate a piano sampler that I prefer. Of course we can generate more samplers like violin, bassoon, clarinet, etc, to create a choir!</p>
<h5 id="section-schedule-the-play">Schedule the Play</h5>
<p><a href="https://tonejs.github.io/docs/Transport" rel="noopener noreferrer" target="_blank">Tone.Transport</a> is the main timekeeper. It can be started, stopped, paused, and adjusted on the fly. <strong>Adjust</strong> here means we can modify the <strong>bpm</strong>, <strong>time signatures</strong>, etc. Additionally, which I think is the most important is that we can arrange events along the Transport. Thus, we can schedule the timeline of the music sheet in advance, and then call <code>Tone.Transport.start</code> to start playing it. The event is also created using <code>Tone.Event</code>. Below are pieces of code for arranging the timeline.</p>
<pre><code class="javascript language-javascript">//adjust the bpm on the fly
midi.header.tempos.forEach((tempo, tempoIndex) =&gt; {
  if (tempoIndex === 0) {
    Tone.Transport.bpm.value = tempo.bpm;
  } else {
    const e = new Tone.Event(time =&gt; {
      Tone.Transport.bpm.value = tempo.bpm;
      this.setState({ ...this.state, originBpm: tempo.bpm });
    });
    e.start(tempo.time);
    this.noteEvents.push(e);
  }
});</code></pre>
<pre><code class="javascript language-javascript">//arrange the music timeline
midi.tracks.forEach((track, trackIndex) =&gt; {
  const synth = this.pianoSynths[trackIndex];
  track.notes.forEach((note, noteIndex) =&gt; {
    const e = new Tone.Event(time =&gt; {
      synth.triggerAttackRelease(note.name, note.duration, time, note.velocity);
      this.props.dispatch(triggerKey(note.name, note.duration));
    });
    e.start(note.time);
    this.noteEvents.push(e);
  });
});</code></pre>
<p>If the song is stopped unexpectedly, we should clean the schedule using <code>Tone.Transport.cancel()</code>, which removes scheduled events from the timeline.</p>
<h5 id="section-control-the-play">Control the Play</h5>
<p><code>Tone.Transport</code> provides apis for simply controlling the play as belows:</p>
<pre><code class="javascript language-javascript">switch(eventType) {
  case "Play": 
    Tone.Transport.start();
    break;

  case "Pause":
    Tone.Transport.pause();
    break;

  case "Resume":
    Tone.Transport.start();
    break;

  case "Stop":
    Tone.Transport.stop();
    break;

  default:
    break;
}</code></pre>
<p>But how to <strong>step forward and backward</strong>. Actually this frustrated me for a while, and at last I came out an idea that was not that perfect in my mind. Unfortunately, Tone didn't provide a straightforward solution. </p>
<p><img loading="lazy" src="/blog/assets/img-piano/3.png" alt=""></p>
<p>As we see from the above piece of music, commonly the piano sheet has at least two tracks. So I keep a record of the last played note in each track, so that I can get the next or the previous note of each track. </p>
<p>For implementing step forward, after I get the next note of each track, I sort both the start point and the end point of all the next notes on the timeline, as below:</p>
<p><img loading="lazy" src="/blog/assets/img-piano/4.jpg" alt=""></p>
<p>Then set the <code>Tone.Transport.position</code> at the first start time, which is <em>track1_note1_start</em> here:</p>
<pre><code class="javascript language-javascript">//start from the nearest next note
Tone.Transport.position = Tone.Time(timeLine[0]).toBarsBeatsSixteenths();</code></pre>
<p>and pause at the end of the first play duration, which is <em>track1_note1_end</em> here.</p>
<pre><code class="javascript language-javascript">//pause after the shortest gap
let duration = 0;
for (let i = 1; i &lt; timeLine.length; i++) {
  const gap = timeLine[i] - timeLine[0];
    if ( gap &gt; 0.0001) {
    duration = gap;
    break;
  }
}

Tone.Transport.start();
Tone.Transport.pause(`+${duration}`); </code></pre>
<p>Dealing with the step backwards is similar, except one tip that <code>Tone.Transport.position</code> should be set at the start point of one note.</p>
<h3 id="section-not-enough-though">Not Enough Though</h3>
<p>This tiny app is far away from good enough, although I can use it to read some sheet music and autoplay the music, following with it. Also it inspires me to create a tiny music game, which creates stuff for interaction at the beats. </p></div></div></article><div><div class="max-w-3xl mx-auto"><div><hr class="border-theme-line mt-6 mb-6"/><div class="flex leading-6 justify-center"><button aria-label="facebook" class="react-share__ShareButton mx-4" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="40" height="40"><circle cx="32" cy="32" r="31" fill="#3b5998"></circle><path d="M34.1,47V33.3h4.6l0.7-5.3h-5.3v-3.4c0-1.5,0.4-2.6,2.6-2.6l2.8,0v-4.8c-0.5-0.1-2.2-0.2-4.1-0.2 c-4.1,0-6.9,2.5-6.9,7V28H24v5.3h4.6V47H34.1z" fill="white"></path></svg></button><button aria-label="twitter" class="react-share__ShareButton mx-4" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="40" height="40"><circle cx="32" cy="32" r="31" fill="#00aced"></circle><path d="M48,22.1c-1.2,0.5-2.4,0.9-3.8,1c1.4-0.8,2.4-2.1,2.9-3.6c-1.3,0.8-2.7,1.3-4.2,1.6 C41.7,19.8,40,19,38.2,19c-3.6,0-6.6,2.9-6.6,6.6c0,0.5,0.1,1,0.2,1.5c-5.5-0.3-10.3-2.9-13.5-6.9c-0.6,1-0.9,2.1-0.9,3.3 c0,2.3,1.2,4.3,2.9,5.5c-1.1,0-2.1-0.3-3-0.8c0,0,0,0.1,0,0.1c0,3.2,2.3,5.8,5.3,6.4c-0.6,0.1-1.1,0.2-1.7,0.2c-0.4,0-0.8,0-1.2-0.1 c0.8,2.6,3.3,4.5,6.1,4.6c-2.2,1.8-5.1,2.8-8.2,2.8c-0.5,0-1.1,0-1.6-0.1c2.9,1.9,6.4,2.9,10.1,2.9c12.1,0,18.7-10,18.7-18.7 c0-0.3,0-0.6,0-0.8C46,24.5,47.1,23.4,48,22.1z" fill="white"></path></svg></button><button aria-label="linkedin" class="react-share__ShareButton mx-4" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="40" height="40"><circle cx="32" cy="32" r="31" fill="#007fb1"></circle><path d="M20.4,44h5.4V26.6h-5.4V44z M23.1,18c-1.7,0-3.1,1.4-3.1,3.1c0,1.7,1.4,3.1,3.1,3.1 c1.7,0,3.1-1.4,3.1-3.1C26.2,19.4,24.8,18,23.1,18z M39.5,26.2c-2.6,0-4.4,1.4-5.1,2.8h-0.1v-2.4h-5.2V44h5.4v-8.6 c0-2.3,0.4-4.5,3.2-4.5c2.8,0,2.8,2.6,2.8,4.6V44H46v-9.5C46,29.8,45,26.2,39.5,26.2z" fill="white"></path></svg></button><button aria-label="weibo" class="react-share__ShareButton mx-4" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="40" height="40"><circle cx="32" cy="32" r="31" fill="#CD201F"></circle><path d="M40.9756152,15.0217119 C40.5000732,15.0546301 39.9999314,15.1204666 39.5325878,15.2192213 C38.6634928,15.4085016 38.0977589,16.2643757 38.2863368,17.1284787 C38.4667163,18.0008129 39.3194143,18.5686519 40.1885094,18.3793715 C42.8613908,17.8115326 45.7720411,18.6427174 47.7316073,20.8153207 C49.6911735,22.996153 50.2077122,25.975254 49.3714112,28.5840234 C49.1008441,29.4316684 49.5763861,30.3533789 50.4208857,30.6249537 C51.2653852,30.8965286 52.1754769,30.4192153 52.4542425,29.5715703 C53.6349013,25.9011885 52.9133876,21.7699494 50.1585171,18.7085538 C48.0923641,16.4042776 45.2063093,15.1533848 42.3530505,15.0217119 C41.8775084,14.9970227 41.4511594,14.9887937 40.9756152,15.0217119 Z M27.9227762,19.8277737 C24.9957268,20.140498 20.863421,22.4365431 17.2312548,26.0822378 C13.2711279,30.0571148 11,34.2871065 11,37.9328012 C11,44.9032373 19.8713401,49.125 28.5786978,49.125 C39.9917329,49.125 47.600423,42.4261409 47.600423,37.1427636 C47.600423,33.9496952 44.9603397,32.1638816 42.549827,31.4149913 C41.9594976,31.2339421 41.5167516,31.1434164 41.8283133,30.3616079 C42.5006339,28.66632 42.6236176,27.1932286 41.8939054,26.1480742 C40.5328692,24.1894405 36.7203236,24.2881952 32.448635,26.0822378 C32.448635,26.0822378 31.1203949,26.6912261 31.4647526,25.6213825 C32.1206742,23.4981576 32.0304845,21.712342 31.0056075,20.6836478 C30.2840938,19.9512176 29.2510184,19.6878718 27.9227762,19.8277737 Z M42.0906819,20.6836478 C41.6233383,20.6589586 41.1723917,20.716566 40.7132466,20.8153207 C39.9671353,20.9716828 39.4997917,21.7781784 39.6637721,22.5270687 C39.8277525,23.275959 40.5574647,23.7450433 41.303576,23.5804521 C42.1972686,23.3911718 43.2057485,23.6380596 43.8616701,24.3704897 C44.5175916,25.1029198 44.6733735,26.0657797 44.3864073,26.9381118 C44.1486363,27.6705419 44.5093932,28.4770397 45.2391054,28.7156963 C45.9688176,28.9461239 46.780521,28.5922524 47.0100936,27.8598223 C47.584026,26.0740087 47.2396661,24.0248493 45.8950269,22.5270687 C44.886547,21.4078489 43.4845162,20.7494842 42.0906819,20.6836478 Z M29.496988,29.9665891 C35.3100922,30.1723275 39.9917329,33.0691319 40.3852858,37.0769272 C40.8362324,41.6607904 35.5970585,45.9319315 28.6442899,46.6232144 C21.6915214,47.3144973 15.6488446,44.154347 15.197898,39.5787128 C14.7469514,34.9948495 20.059916,30.7237084 27.004486,30.0324256 C27.8735831,29.950131 28.6688875,29.9336709 29.496988,29.9665891 Z M25.5614586,34.3776322 C23.183744,34.5916017 20.9372116,35.9577073 19.9205332,37.9328012 C18.5348994,40.6238672 19.9041362,43.6029661 23.0689567,44.582284 C26.340366,45.5945202 30.1857056,44.0638213 31.5303448,41.1587879 C32.8503864,38.3195909 31.1613894,35.3734082 27.9227762,34.5751416 C27.1438688,34.3776322 26.356763,34.3035667 25.5614586,34.3776322 Z M24.052839,38.7228388 C24.3316067,38.7310678 24.5857748,38.8215935 24.8399449,38.9203482 C25.8648218,39.3400561 26.1845841,40.4428158 25.5614586,41.4221338 C24.9219361,42.3932227 23.5690963,42.8623069 22.5442194,42.4096807 C21.5357395,41.9652856 21.2487754,40.8542948 21.8882979,39.9078951 C22.3638421,39.2001542 23.2247386,38.7146097 24.052839,38.7228388 Z" fill="white"></path></svg></button></div></div><div><hr class="border-theme-line mt-6 mb-6"/><div class="flex leading-6 font-medium text-lg"><a class="flex mr-8 transition-colors duration-200 text-theme-link hover:text-theme-link-highlight" href="/posts/2019-4-29-wechatmini"><span aria-hidden="true" class="mr-2">←</span>Previous Post</a><a class="flex text-right ml-auto transition-colors duration-200 text-theme-link hover:text-theme-link-highlight" href="/posts/2019-8-22-pregnancy-delivery">Next Post<span aria-hidden="true" class="ml-2">→</span></a></div></div><div><hr class="border-theme-line mt-6 mb-6"/><div shortname="https-imagicbell-github-io" config="[object Object]" id="disqus_thread"></div></div></div><div class="max-w-5xl mx-auto"><div><hr class="border-theme-line mt-6 mb-6"/><div class="pt-4 pb-6"><h2 class="text-xl font-medium leading-tight md:leading-none mb-6 text-center">MORE FROM THE BLOG</h2><div class="grid grid-flow-row grid-cols-2 grid-rows-2 lg:grid-cols-4 lg:grid-rows-1 gap-4"><div class="relative h-60 border rounded border-theme-border cursor-pointer hover:shadow-md p-2"><div class="absolute left-0 top-0 w-full h-24 bg-theme-bg"></div><div class="relative h-20 mb-2 overflow-hidden"><p class="absolute bottom-0 text-lg text-left font-medium">Use React Context + useReducer...</p></div><div class="overflow-hidden h-24"><div class="markdown-body markdown-styles_markdown__1x9gM"><p>React Hooks have brought us much convenience in writing concise readable code. Recently, I have been enjoying the usage of...</p></div></div><div class="text-xs text-theme-meta absolute bottom-2 flex flex-col sm:flex-row sm:items-center"><time dateTime="2021-07-07T20:00:00+08:00">July	7, 2021</time><div class="w-px h-px border rounded mx-2 border-theme-meta hidden sm:block"></div><span>4min read</span></div><a class="absolute top-0 left-0 w-full h-full" href="/posts/2021-7-7-react-usecontext-usereducer"></a></div><div class="relative h-60 border rounded border-theme-border cursor-pointer hover:shadow-md p-2"><div class="absolute left-0 top-0 w-full h-24 bg-theme-bg"></div><div class="relative h-20 mb-2 overflow-hidden"><p class="absolute bottom-0 text-lg text-left font-medium">How To Build My Own...</p></div><div class="overflow-hidden h-24"><div class="markdown-body markdown-styles_markdown__1x9gM">This article illustrates how I applied image optimization to improve the performance of my website.</div></div><div class="text-xs text-theme-meta absolute bottom-2 flex flex-col sm:flex-row sm:items-center"><time dateTime="2021-06-05T20:00:00+08:00">June	5, 2021</time><div class="w-px h-px border rounded mx-2 border-theme-meta hidden sm:block"></div><span>2min read</span></div><a class="absolute top-0 left-0 w-full h-full" href="/posts/2021-6-5-build-my-website-image-opti"></a></div><div class="relative h-60 border rounded border-theme-border cursor-pointer hover:shadow-md p-2"><div class="absolute left-0 top-0 w-full h-24 bg-theme-bg"></div><div class="relative h-20 mb-2 overflow-hidden"><p class="absolute bottom-0 text-lg text-left font-medium">How To Build My Own...</p></div><div class="overflow-hidden h-24"><div class="markdown-body markdown-styles_markdown__1x9gM">This article illustrates how I style my own website using Tailwindcss framework, make theme color configurable, and apply interactive animations.</div></div><div class="text-xs text-theme-meta absolute bottom-2 flex flex-col sm:flex-row sm:items-center"><time dateTime="2021-03-14T20:00:00+08:00">March	14, 2021</time><div class="w-px h-px border rounded mx-2 border-theme-meta hidden sm:block"></div><span>2min read</span></div><a class="absolute top-0 left-0 w-full h-full" href="/posts/2021-3-14-build-my-website-style"></a></div><div class="relative h-60 border rounded border-theme-border cursor-pointer hover:shadow-md p-2"><div class="absolute left-0 top-0 w-full h-24 bg-theme-bg"></div><div class="relative h-20 mb-2 overflow-hidden"><p class="absolute bottom-0 text-lg text-left font-medium">How To Build My Own...</p></div><div class="overflow-hidden h-24"><div class="markdown-body markdown-styles_markdown__1x9gM"><p>Parsing and displaying Markdown files are one of the most important things in building a personal website, because all my...</p></div></div><div class="text-xs text-theme-meta absolute bottom-2 flex flex-col sm:flex-row sm:items-center"><time dateTime="2021-03-12T20:00:00+08:00">March	12, 2021</time><div class="w-px h-px border rounded mx-2 border-theme-meta hidden sm:block"></div><span>3min read</span></div><a class="absolute top-0 left-0 w-full h-full" href="/posts/2021-3-12-build-my-website-markdown"></a></div></div></div></div></div></div></div></main></div><footer class="w-full bg-theme-bg-strong px-container py-4 text-theme-bg-strong-text flex flex-col items-center"><nav class="text-base md:text-lg flex justify-end items-center"><a class="border-b-2 border-theme-bg-strong-text border-opacity-0 hover:border-opacity-100 mx-2 md:mx-4" href="/">Home</a><a class="border-b-2 border-theme-bg-strong-text border-opacity-0 hover:border-opacity-100 mx-2 md:mx-4" href="/blog">Blog</a><a class="border-b-2 border-theme-bg-strong-text border-opacity-0 hover:border-opacity-100 mx-2 md:mx-4" href="/resume">Resume</a></nav><div class="w-full my-2 flex flex-col sm:flex-row justify-between"><div class="text-xs">© 2021 Ling Mao. Powered by <a class="hover:underline" href="https://reactjs.org/" rel="nofollow">React</a> &amp; <a class="hover:underline" href="https://nextjs.org/" rel="nofollow">Next.js</a>.</div><div class="flex justify-center sm:justify-end items-center"><a href="mailto:sophieml1989@gmail.com" class="mr-4"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="envelope" class="svg-inline--fa fa-envelope fa-w-16 h-6" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" color="#fff"><path fill="currentColor" d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path></svg></a><a href="https://www.linkedin.com/in/magicbell" class="mr-4"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="linkedin-in" class="svg-inline--fa fa-linkedin-in fa-w-14 h-6" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" color="#fff"><path fill="currentColor" d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"></path></svg></a><a href="https://github.com/imagicbell" class="mr-4"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github fa-w-16 h-6" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" color="#fff"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"A Simple Piano App Developed By Tonejs","date":"2019-06-15T10:00:00+08:00","slug":"2019-6-15-piano-app","description":"Use React and Tonejs to develop a simple piano app.","ogImage":"/blog/assets/img-piano/1.jpg","categories":["Front-End"],"readTime":5,"content":"\u003ch3 id=\"section-motivation\"\u003eMotivation\u003c/h3\u003e\n\u003cp\u003eWhen I was pregnant, my husband bought me a piano, because he wanted us and our baby to learn piano together. Hmm… a good point:)\u003c/p\u003e\n\u003cp\u003eBut I found it difficult to find a free app that teaches me how to play. Most of the sheet music that I love are in-app purchases. So I decided to make a simple app to help myself read sheet and play piano.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/imagicbell/piano-app\" rel=\"noopener noreferrer\" target=\"_blank\"\u003eGitHub link\u003c/a\u003e.\u003c/p\u003e\n\u003ch3 id=\"section-a-glance\"\u003eA Glance\u003c/h3\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/blog/assets/img-piano/1.jpg\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/blog/assets/img-piano/2.jpg\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eThis is how it looks. \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eThe white and black keys on the piano can be clicked to play.\u003c/li\u003e\n\u003cli\u003eIt supports two types of music files: MIDI and MusicXML. Also it outputs the parsed json content of the music files.\u003c/li\u003e\n\u003cli\u003eIt provides a simple play control, including play, pause, resume, step forward and backward, as well as the playback speed.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"section-deep-into-the-main-features\"\u003eDeep Into The Main Features\u003c/h3\u003e\n\u003ch4 id=\"section-1-the-keyboard-interface\"\u003e1. The Keyboard Interface\u003c/h4\u003e\n\u003cp\u003eThis little virtual keyboard is simply created by css styles, calculating the position and color of each key. Also bind the click event to each key with a unique identifier. \u003c/p\u003e\n\u003cp\u003eIn addition, to fullfil autoplay, I use redux state. Connect the key states to the \u003ccode\u003eactiveKeys\u003c/code\u003e in the redux store, which can be updated somewhere else, e.g. the midi player.\u003c/p\u003e\n\u003ch4 id=\"section-2-read-music-sheet\"\u003e2. Read Music Sheet\u003c/h4\u003e\n\u003cp\u003eWe support two music file types: MIDI and MusicXML. Reading MIDI files can be simply done using \u003ca href=\"https://github.com/Tonejs/Midi\" rel=\"noopener noreferrer\" target=\"_blank\"\u003etonejs/midi\u003c/a\u003e, which provides api to load MIDI files into javascript object, so I can retrieve the information needed to play using Tonejs. \u003c/p\u003e\n\u003cp\u003eFor MusicXML, I use \u003ca href=\"https://github.com/jnetterf/musicxml-interfaces\" rel=\"noopener noreferrer\" target=\"_blank\"\u003emusicxml-interfaces\u003c/a\u003e, which helps me to parse alien sheet music into javascript object. The most difficult and time consuming part is then to extract and organise the information needed to play using Tonejs. I checked \u003ca href=\"https://www.musicxml.com/tutorial/\" rel=\"noopener noreferrer\" target=\"_blank\"\u003emusicxml docs\u003c/a\u003e a lot for understanding what each element in the sheet music means. Maybe now there are many good works out there which can accomplish this task. If you are interested in the detailed implementation, you can reference the musicxml docs and dive deep into my code. I will ignore the illustration here, as it is really a long story.\u003c/p\u003e\n\u003ch4 id=\"section-3-display-music-sheet\"\u003e3. Display Music Sheet\u003c/h4\u003e\n\u003cp\u003eI use \u003ca href=\"https://github.com/opensheetmusicdisplay/opensheetmusicdisplay\" rel=\"noopener noreferrer\" target=\"_blank\"\u003eOpenSheetMusicDisplay\u003c/a\u003e to render MusicXML sheet music, which is really a wonderful tool. The usage is quite simple. Call the constructor first, and then load the mxl file, which is a promise. Call render function when the promise resolves.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"javascript language-javascript\"\u003ecomponentDidMount() {\n  this.osmd = new OpenSheetMusicDisplay(\"osmd\");\n}\n\ncomponentWillReceiveProps(nextProps: MusicSheetProps) {\n  if (!nextProps.content) {\n    this.osmd.clear();\n    return;\n  }\n  this.osmd.load(nextProps.content).then(\n    () =\u0026gt; {\n      this.osmd.render()\n    }, (e) =\u0026gt; {\n    console.log(\"music sheet load error\\n\", e);\n  });\n}\u003c/code\u003e\u003c/pre\u003e\n\u003ch4 id=\"section-4-play-music\"\u003e4. Play Music\u003c/h4\u003e\n\u003cp\u003eThis is the part of playing with Tonejs. \u003c/p\u003e\n\u003ch5 id=\"section-sound-generation\"\u003eSound Generation\u003c/h5\u003e\n\u003cp\u003eI chose \u003ca href=\"https://tonejs.github.io/docs/Sampler.html\" rel=\"noopener noreferrer\" target=\"_blank\"\u003eTone.Sampler\u003c/a\u003e to generate the piano sounds. I followed the code from \u003ca href=\"https://github.com/nbrosowsky/tonejs-instruments\" rel=\"noopener noreferrer\" target=\"_blank\"\u003etonejs-instruments\u003c/a\u003e and only generate a piano sampler that I prefer. Of course we can generate more samplers like violin, bassoon, clarinet, etc, to create a choir!\u003c/p\u003e\n\u003ch5 id=\"section-schedule-the-play\"\u003eSchedule the Play\u003c/h5\u003e\n\u003cp\u003e\u003ca href=\"https://tonejs.github.io/docs/Transport\" rel=\"noopener noreferrer\" target=\"_blank\"\u003eTone.Transport\u003c/a\u003e is the main timekeeper. It can be started, stopped, paused, and adjusted on the fly. \u003cstrong\u003eAdjust\u003c/strong\u003e here means we can modify the \u003cstrong\u003ebpm\u003c/strong\u003e, \u003cstrong\u003etime signatures\u003c/strong\u003e, etc. Additionally, which I think is the most important is that we can arrange events along the Transport. Thus, we can schedule the timeline of the music sheet in advance, and then call \u003ccode\u003eTone.Transport.start\u003c/code\u003e to start playing it. The event is also created using \u003ccode\u003eTone.Event\u003c/code\u003e. Below are pieces of code for arranging the timeline.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"javascript language-javascript\"\u003e//adjust the bpm on the fly\nmidi.header.tempos.forEach((tempo, tempoIndex) =\u0026gt; {\n  if (tempoIndex === 0) {\n    Tone.Transport.bpm.value = tempo.bpm;\n  } else {\n    const e = new Tone.Event(time =\u0026gt; {\n      Tone.Transport.bpm.value = tempo.bpm;\n      this.setState({ ...this.state, originBpm: tempo.bpm });\n    });\n    e.start(tempo.time);\n    this.noteEvents.push(e);\n  }\n});\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"javascript language-javascript\"\u003e//arrange the music timeline\nmidi.tracks.forEach((track, trackIndex) =\u0026gt; {\n  const synth = this.pianoSynths[trackIndex];\n  track.notes.forEach((note, noteIndex) =\u0026gt; {\n    const e = new Tone.Event(time =\u0026gt; {\n      synth.triggerAttackRelease(note.name, note.duration, time, note.velocity);\n      this.props.dispatch(triggerKey(note.name, note.duration));\n    });\n    e.start(note.time);\n    this.noteEvents.push(e);\n  });\n});\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIf the song is stopped unexpectedly, we should clean the schedule using \u003ccode\u003eTone.Transport.cancel()\u003c/code\u003e, which removes scheduled events from the timeline.\u003c/p\u003e\n\u003ch5 id=\"section-control-the-play\"\u003eControl the Play\u003c/h5\u003e\n\u003cp\u003e\u003ccode\u003eTone.Transport\u003c/code\u003e provides apis for simply controlling the play as belows:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"javascript language-javascript\"\u003eswitch(eventType) {\n  case \"Play\": \n    Tone.Transport.start();\n    break;\n\n  case \"Pause\":\n    Tone.Transport.pause();\n    break;\n\n  case \"Resume\":\n    Tone.Transport.start();\n    break;\n\n  case \"Stop\":\n    Tone.Transport.stop();\n    break;\n\n  default:\n    break;\n}\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eBut how to \u003cstrong\u003estep forward and backward\u003c/strong\u003e. Actually this frustrated me for a while, and at last I came out an idea that was not that perfect in my mind. Unfortunately, Tone didn't provide a straightforward solution. \u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/blog/assets/img-piano/3.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eAs we see from the above piece of music, commonly the piano sheet has at least two tracks. So I keep a record of the last played note in each track, so that I can get the next or the previous note of each track. \u003c/p\u003e\n\u003cp\u003eFor implementing step forward, after I get the next note of each track, I sort both the start point and the end point of all the next notes on the timeline, as below:\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/blog/assets/img-piano/4.jpg\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eThen set the \u003ccode\u003eTone.Transport.position\u003c/code\u003e at the first start time, which is \u003cem\u003etrack1_note1_start\u003c/em\u003e here:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"javascript language-javascript\"\u003e//start from the nearest next note\nTone.Transport.position = Tone.Time(timeLine[0]).toBarsBeatsSixteenths();\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eand pause at the end of the first play duration, which is \u003cem\u003etrack1_note1_end\u003c/em\u003e here.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"javascript language-javascript\"\u003e//pause after the shortest gap\nlet duration = 0;\nfor (let i = 1; i \u0026lt; timeLine.length; i++) {\n  const gap = timeLine[i] - timeLine[0];\n    if ( gap \u0026gt; 0.0001) {\n    duration = gap;\n    break;\n  }\n}\n\nTone.Transport.start();\nTone.Transport.pause(`+${duration}`); \u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eDealing with the step backwards is similar, except one tip that \u003ccode\u003eTone.Transport.position\u003c/code\u003e should be set at the start point of one note.\u003c/p\u003e\n\u003ch3 id=\"section-not-enough-though\"\u003eNot Enough Though\u003c/h3\u003e\n\u003cp\u003eThis tiny app is far away from good enough, although I can use it to read some sheet music and autoplay the music, following with it. Also it inspires me to create a tiny music game, which creates stuff for interaction at the beats. \u003c/p\u003e"},"postNav":{"previous":"/posts/2019-4-29-wechatmini","next":"/posts/2019-8-22-pregnancy-delivery"},"morePosts":[{"slug":"2021-7-7-react-usecontext-usereducer","title":"Use React Context + useReducer to Implement A Simple State Management Like Redux","date":"2021-07-07T20:00:00+08:00","locale":"en","readTime":4,"excerpt":"\u003cp\u003eReact Hooks have brought us much convenience in writing concise readable code. Recently, I have been enjoying the usage of...\u003c/p\u003e"},{"slug":"2021-6-5-build-my-website-image-opti","title":"How To Build My Own Website (4) - Image Optimization","date":"2021-06-05T20:00:00+08:00","locale":"en","excerpt":"This article illustrates how I applied image optimization to improve the performance of my website.","readTime":2},{"slug":"2021-3-14-build-my-website-style","title":"How To Build My Own Website (3) - Style","date":"2021-03-14T20:00:00+08:00","locale":"en","excerpt":"This article illustrates how I style my own website using Tailwindcss framework, make theme color configurable, and apply interactive animations.","readTime":2},{"slug":"2021-3-12-build-my-website-markdown","title":"How To Build My Own Website (2) - Markdown","date":"2021-03-12T20:00:00+08:00","locale":"en","readTime":3,"excerpt":"\u003cp\u003eParsing and displaying Markdown files are one of the most important things in building a personal website, because all my...\u003c/p\u003e"}]},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"2019-6-15-piano-app"},"buildId":"M1ImC2xABqLwuGigGhbUg","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-ef3d50462330da67074a.js"></script><script src="/_next/static/chunks/main-e903dbcb0f26f07bddca.js" async=""></script><script src="/_next/static/chunks/webpack-245f049e565ebf942e09.js" async=""></script><script src="/_next/static/chunks/framework.29f9e2f3d4a33bafbaa5.js" async=""></script><script src="/_next/static/chunks/commons.449049b2eba38352d9f4.js" async=""></script><script src="/_next/static/chunks/pages/_app-8c930b98cabfdb7a913b.js" async=""></script><script src="/_next/static/chunks/cb1608f2.16ad8215560a85b40620.js" async=""></script><script src="/_next/static/chunks/a9a7754c.dec6fcf45fa1bcf7c2c8.js" async=""></script><script src="/_next/static/chunks/eda77bfa782fcce19c31e9417d5ccf0cdb548971.d0a029473df3535a2906.js" async=""></script><script src="/_next/static/chunks/8410e8da63518be12bbb03b338cbeeeaa2b87d98.22e74b4b4510f82d44b7.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-3941c16fb34e6e40ffc2.js" async=""></script><script src="/_next/static/M1ImC2xABqLwuGigGhbUg/_buildManifest.js" async=""></script><script src="/_next/static/M1ImC2xABqLwuGigGhbUg/_ssgManifest.js" async=""></script></body></html>