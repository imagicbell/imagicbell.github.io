<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"/><link rel="manifest" href="/favicon/site.webmanifest"/><link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#fca5a5"/><link rel="shortcut icon" href="/favicon/favicon.ico"/><meta name="msapplication-TileColor" content="#fca5a5"/><meta name="msapplication-config" content="/favicon/browserconfig.xml"/><meta name="theme-color" content="#fca5a5"/><meta property="og:type" content="website"/><meta property="og:title" content="Magicbell&#x27;s Website"/><meta property="og:url" content="/"/><meta property="og:description" content="Welcome to Magicbell&#x27;s Website, a place where you will know more about me from my professional experience and technical posts."/><meta property="og:image" content="/_next/static/images/avatar-b229a410146fdbebcd2035ef237d2ad0.jpg"/><title>Google Blockly Reimplementation with Unity/C#(4)</title><meta name="description" content=""/><meta property="og:type" content="website"/><meta property="og:title" content="Google Blockly Reimplementation with Unity/C#(4)"/><meta property="og:url" content="/posts/2017-10-31-blockly-four"/><meta property="og:description" content=""/><meta property="og:image" content="/blog/assets/img-blockly/Demo.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Google Blockly Reimplementation with Unity/C#(4)"/><meta name="twitter:description" content=""/><meta name="twitter:image" content="/blog/assets/img-blockly/Demo.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"/><script defer="" src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script><meta name="next-head-count" content="29"/><link rel="preload" href="/_next/static/css/555b173cbb3b3b45df80.css" as="style"/><link rel="stylesheet" href="/_next/static/css/555b173cbb3b3b45df80.css" data-n-g=""/><link rel="preload" href="/_next/static/css/1a68ae46e299420c5773.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1a68ae46e299420c5773.css" data-n-p=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-e903dbcb0f26f07bddca.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-245f049e565ebf942e09.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.29f9e2f3d4a33bafbaa5.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.449049b2eba38352d9f4.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-8c930b98cabfdb7a913b.js" as="script"/><link rel="preload" href="/_next/static/chunks/cb1608f2.16ad8215560a85b40620.js" as="script"/><link rel="preload" href="/_next/static/chunks/a9a7754c.dec6fcf45fa1bcf7c2c8.js" as="script"/><link rel="preload" href="/_next/static/chunks/eda77bfa782fcce19c31e9417d5ccf0cdb548971.a781f33eec1afd4f91b3.js" as="script"/><link rel="preload" href="/_next/static/chunks/8410e8da63518be12bbb03b338cbeeeaa2b87d98.22e74b4b4510f82d44b7.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bslug%5D-a69c9fc3973d7a021c84.js" as="script"/></head><body><div id="__next"><div class="min-h-screen"><div class="w-full bg-theme-bg-strong flex justify-between items-end px-container py-4 text-theme-bg-strong-text"><h2 class="text-xl md:text-3xl font-bold tracking-tighter md:tracking-tight"><a class="" href="/">Magicbell&#x27;s Website</a></h2><nav class="text-base md:text-lg flex justify-end items-center"><a class="border-b-2 border-theme-bg-strong-text border-opacity-0 hover:border-opacity-100 mx-2 md:mx-4" href="/blog">Blog</a><a class="border-b-2 border-theme-bg-strong-text border-opacity-0 hover:border-opacity-100 mx-2 md:mx-4" href="/resume">Resume</a></nav></div><main class="relative container mx-auto my-14 px-container"><div class="mx-auto"><article class="mb-20"><div class="max-w-4xl mx-auto mb-20"><h1 class="text-4xl md:text-5xl lg:text-6xl font-bold tracking-tighter leading-tight md:leading-none mb-6 text-center md:text-left">Google Blockly Reimplementation with Unity/C#(4)</h1><div class="text-base text-theme-meta flex items-center"><time dateTime="2017-10-31T20:00:00+08:00">October	31, 2017</time><div class="w-px h-px border rounded mx-3 border-theme-meta"></div><span>8min read</span></div><hr class="border-theme-line mt-2"/></div><div class="max-w-3xl mx-auto"><div class="markdown-body markdown-styles_markdown__1x9gM"><h2 id="section-contents">Contents</h2>
<ol>
<li><a href="/posts/2017-10-11-blockly-one" rel="noopener noreferrer" target="_blank">Introduction</a></li>
<li><a href="/posts/2017-10-14-blockly-two" rel="noopener noreferrer" target="_blank">Blockly Model</a></li>
<li><a href="/posts/2017-10-22-blockly-three" rel="noopener noreferrer" target="_blank">Code Generator, Interpreter and Runner</a></li>
<li>UGUI Design</li>
</ol>
<p><br></p>
<h2 id="section-ugui-design">UGUI Design</h2>
<p>在设计Blockly UI时，主要考虑解决以下几个问题：</p>
<ol>
<li><a id="q1"></a>自动生成Block View，可以在Editor里预生成Prefab，也可以Runtime时动态生成GameObject。</li>
<li><a id="q2"></a>动态Layout，根据Block View的实际计算大小，以及View之间的相互连接，实现动态布局、缩放。</li>
<li><a id="q3"></a>动态Layout后，Block View底图的实时绘制。</li>
<li><a id="q4"></a>独立Blockly Model模块，采用观察者模式监听Model的变化。</li>
<li><a id="q5"></a>Block View最近连接的搜索。</li>
<li><a id="q6"></a>可重建Workspace，可复制Block View，可变形Block View。</li>
</ol>
<h3 id="section-hierarchy-of-views">Hierarchy of Views</h3>
<p>首先，需要设计一套View Hierarchy，既能符合Block Model的结构，表现Blocks之间的Connection，又能结合UGUI Transform Hierarchy，实现动态Layout计算。</p>
<p>回顾<a href="/posts/2017-10-14-blockly-two#block" rel="noopener noreferrer" target="_blank">讲解Block Model的章节</a>中关于Block Hierarchy的介绍，可知Block包括Connections、Inputs，而Inputs包括Fields、Connections，Connections可以连接其他Blocks，这些元素均需在UI上体现出来。在此基础上，我们还增加了一个LineGroup，因为某些Block View需要将Inputs分布在多行，LineGroup是用来包裹一行的Inputs。因此，最终的<a id="view-hierarchy">View Hierarchy</a>如下：</p>
<pre><code>hierarchy of view:

- Block
  - ConnectionOutput
  - ConnectionPrev  
  - ConnectionNext
    - Block(Next)

  - LineGroup
    - Input
      - Field 
      - Field 
      ...
      - ConnectionInput
        - Block(Input)
    - Input
      ...
  - LineGroup
    ...
  ...
- Block
  ... </code></pre>
<h4 id="section-抽象基类baseview">抽象基类BaseView</h4>
<p>Hierarchy中的每一个元素，都是一个View，因此我们抽象了基类<code>BaseView</code>，它继承<code>MonoBehaviour</code>，管理了：</p>
<ul>
<li>链式结构：Parent, Childs, Previous, Next。</li>
<li>自下而上的迭代式Layout Update，<a href="#layout-example1">详见这里</a>。</li>
</ul>
<h4 id="section-子类views类型">子类Views类型</h4>
<p>依据<a href="#view-hierarchy">Hierarchy</a>，设计了6个基本的View类型：</p>
<p><code>BlockView</code>, <code>ConnectionView</code>, <code>LineGroupView</code>, <code>InputView</code>,<code>FieldView</code>, <code>ConnectionInputView</code></p>
<p>其中ConnectionInputView继承自ConnectionView，在Model中都体现为Connection，但在UI表现上ConnectionInputView是包裹输入Block的，而ConnectionView是挂载Next Block。</p>
<p>基于这样的设计，可以很好的解决问题<a href="#q1">1</a>、<a href="#q2">2</a>、<a href="#q3">3</a>。</p>
<h3 id="section-auto-build-block-view">Auto Build Block View</h3>
<p>无论是Editor预生成Prefab，还是Runtime动态生成，Block View是依赖于Block Model来生成的。依照自上而下的顺序依次创建：</p>
<p><em>Block</em> -&gt; <em>Connection, LineGroup</em> -&gt; <em>Input</em> -&gt; <em>Field</em> </p>
<p>并且同时设置好链式关系，通过<code>MonoBehaviour</code>序列化保存下来。</p>
<h3 id="section-dynamic-layout">Dynamic Layout</h3>
<p>为什么需要Dynamic Layout，它需要做什么？先看下面两个例子：</p>
<p><a id="layout-example1">例1</a></p>
<p><img loading="lazy" src="/blog/assets/img-blockly/Layout_1.png" alt=""> -&gt; <img src="/blog/assets/img-blockly/Layout_2.png" alt=""></p>
<p><a id="layout-example2">例2</a></p>
<p><img loading="lazy" src="/blog/assets/img-blockly/Layout_3.png" alt=""> -&gt; <img src="/blog/assets/img-blockly/Layout_4.png" alt=""></p>
<p>可以看出：</p>
<ol>
<li>Block的Size会根据其自身Fields大小，以及其Child Blocks大小进行缩放；</li>
<li>Block自身Fields的起始位置，以及Blocks相互之间的起始位置，都会根据缩放后的大小进行重新摆放；</li>
</ol>
<p>因此经过Dynamic Layout之后，布局更紧凑，更美观！那么如何实现的？</p>
<p>UGUI有一套Layout机制，是依赖于Transform Hierarchy，在每一个生命周期的Update之后统一计算的，先后不可控，因此无法根据View的依赖关系按照正确的顺序计算。</p>
<p>什么是正确的顺序？四个字概括：自下而上。依赖已经建立好的<a href="#view-hierarchy">Hierarchy</a>，先从最小的元素Fields开始，计算起始位置和大小，然后遍历Next，依次叠加大小来计算起始位置，然后Parent，迭代下去，直到结束。代码大致如下：</p>
<pre><code class="c# language-c#">Vector2 newSize = CalculateSize();
if (XY != startPos) XY = startPos;
if (Size != newSize) Size = newSize;

switch (Type)
{
    case ViewType.Field:
    case ViewType.Input:
    case ViewType.ConnectionInput:
    case ViewType.LineGroup:
    {
        if (m_Next == null)
        {
            //reach the last child, or no change in current hierarchy, update it's parent view
            m_Parent.UpdateLayout(m_Parent.SiblingIndex == 0 ? m_Parent.HeaderXY : m_Parent.XY);
        }
        else
        {
            //update next
            if (Type != ViewType.LineGroup)
            {
                // same line
                startPos.x += Size.x + BlockViewSettings.Get().ContentSpace.x;
            }
            else
            {
                // start a new line
                startPos.y -= Size.y + BlockViewSettings.Get().ContentSpace.y;
            }

            BaseView topmostChild = m_Next.GetTopmostChild();
            if (topmostChild != m_Next)
            {
                //need to update from its topmost child
                m_Next.XY = startPos;
                topmostChild.UpdateLayout(topmostChild.HeaderXY);
            }
            else
            {
                m_Next.UpdateLayout(startPos);
            }
        }
        break;
    }
    case ViewType.Connection:
    case ViewType.Block:
    {
        //no need to update its m_Next, as it is handled by Unity's Transform autolayout 
        //update its parent directly
        if (m_Parent != null)
        {
            m_Parent.UpdateLayout(m_Parent.SiblingIndex == 0 ? m_Parent.HeaderXY : m_Parent.XY);
        }
        break;
    }
}</code></pre>
<h3 id="section-custom-background-draw">Custom Background Draw</h3>
<p>动态Layout之后，带来的就是底图的实时绘制，当然采用了九宫格的方式，但是简单的九宫格缩放不能满足需求，看这个：</p>
<p><img loading="lazy" src="/blog/assets/img-blockly/Layout_5.png" alt=""></p>
<p>而这里只用了一张原图：</p>
<p><img loading="lazy" src="/blog/assets/img-blockly/Layout_6.png" alt=""></p>
<p>当然颜色是自定义设置的，通过UGUI Image面板设置。</p>
<p>其实方法很简单，参照UGUI中绘制<code>Image</code>的方法，重载<code>OnPopulateMesh(VertexHelper)</code>方法，按照九宫格的方式设置好顶点、uv，即可：</p>
<p><img loading="lazy" src="/blog/assets/img-blockly/Layout_7.png" alt="">  -&gt;  <img src="/blog/assets/img-blockly/Layout_8.png" alt=""></p>
<p>上图用圆点标记的，是由外部Layout计算好之后的每一个LineGroup的顶点min, max。分析与代码详见<a href="/posts/2017-12-1-unity-image-manipulation" rel="noopener noreferrer" target="_blank">这篇</a>。</p>
<p>动态绘制底图还有一个好处是：不需要拼接图片，减少了资源量，并且避免了Draw Call的增加。</p>
<h3 id="section-observer-pattern">Observer Pattern</h3>
<p>因为一开始设计的初衷是Model模块完全独立于另外两个模块Interpreter、UI，如果想要移植，完全可以以Model为核心，重新设计这两个模块。因此需要实现Model模块的完全解耦，而Google Blockly Web版是将UI与Model耦合在一起了，也许并不需要考虑移植。</p>
<p>观察者模式，是实现UI与Model之间通信的最好方式，Model是事件的发布者，是任何变化、计算的核心，而UI是监听者，监听Model的变化更新表现，以及将用户输入转化为通知Model变化的信号。</p>
<p>这是个经典的设计模式，在此不再赘述。</p>
<h3 id="section-binary-search-nearest">Binary Search Nearest</h3>
<p>搜索最近连接，如果全局遍历所有的Connection Point，时间复杂度为<em>O(n)</em>，并且需要计算距离进行比对，无疑是一项耗cpu的操作。所幸的是Google Blockly提供了一套算法方案，二分搜索法。</p>
<p>二分搜索法的前提是，有序序列，因此需要对Workspace中的所有Connection Point进行排列。做法是：</p>
<ol>
<li>基于Point的<code>y</code>坐标，维护一个有序的Connection Point Map。</li>
<li>每当Block改变时（增、删、移动），将其Connection Point插入到Map中合适的位置，这个位置也是通过二分搜索法查找，只考虑<code>y</code>坐标。</li>
</ol>
<p>当要搜索Connection时，先通过<code>y</code>坐标找到其在Map中的位置，然后向两边查找。时间复杂度为<em>O(logn)</em>。</p>
<p>当要搜索最近Connection时，也是先通过<code>y</code>坐标找到其在Map中的位置，然后向两边通过比对距离来查找，也考虑Connection的兼容性（例如：数学运算符两边只允许数字输入）。时间复杂度为<em>O(logn)</em>，并且也平均减少了计算量。</p>
<h3 id="section-manipulate-views">Manipulate Views</h3>
<p>基于以上，操作Block View就变得很方便，因为自动化，动态，并且极大程度的优化了性能。</p>
<h4 id="section-重建workspace">重建Workspace</h4>
<p>Model层可以将Workspace保存为Xml文件，Xml文件可以再重建Workspace（见<a href="/posts/2017-10-14-blockly-two#workspace_xml" rel="noopener noreferrer" target="_blank">前文</a>）。通过Workspace中Block Models，可以动态创建Block Views，并依据Connections，以及顶层Blocks的位置，实现自动Layout。</p>
<h4 id="section-复制block-view">复制Block View</h4>
<p>Workspace可以保存为Xml文件，当然是基于Block可以保存为一个Xml Node，因此复制Block可以通过将原Block保存为Xml Node，然后从Xml Node重建一个新的Block，再通过Block动态创建Block View。</p>
<h4 id="section-变形block-view">变形Block View</h4>
<p>Block具有<a href="/posts/2017-10-14-blockly-two#section-mutation特性" rel="noopener noreferrer" target="_blank">Mutation特性</a>，可以动态修改Block结构，因此动态生成Block View的功能为此提供了便利，可以动态增删Input Views。</p>
<p>UI部分还有很多可以优化，暂时先介绍这么多。当然如果有更好的设计方案，也欢迎指出，互相学习～</p></div></div></article><div><div class="max-w-3xl mx-auto"><div><hr class="border-theme-line mt-6 mb-6"/><div class="flex leading-6 justify-center"><button aria-label="facebook" class="react-share__ShareButton mx-4" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="40" height="40"><circle cx="32" cy="32" r="31" fill="#3b5998"></circle><path d="M34.1,47V33.3h4.6l0.7-5.3h-5.3v-3.4c0-1.5,0.4-2.6,2.6-2.6l2.8,0v-4.8c-0.5-0.1-2.2-0.2-4.1-0.2 c-4.1,0-6.9,2.5-6.9,7V28H24v5.3h4.6V47H34.1z" fill="white"></path></svg></button><button aria-label="twitter" class="react-share__ShareButton mx-4" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="40" height="40"><circle cx="32" cy="32" r="31" fill="#00aced"></circle><path d="M48,22.1c-1.2,0.5-2.4,0.9-3.8,1c1.4-0.8,2.4-2.1,2.9-3.6c-1.3,0.8-2.7,1.3-4.2,1.6 C41.7,19.8,40,19,38.2,19c-3.6,0-6.6,2.9-6.6,6.6c0,0.5,0.1,1,0.2,1.5c-5.5-0.3-10.3-2.9-13.5-6.9c-0.6,1-0.9,2.1-0.9,3.3 c0,2.3,1.2,4.3,2.9,5.5c-1.1,0-2.1-0.3-3-0.8c0,0,0,0.1,0,0.1c0,3.2,2.3,5.8,5.3,6.4c-0.6,0.1-1.1,0.2-1.7,0.2c-0.4,0-0.8,0-1.2-0.1 c0.8,2.6,3.3,4.5,6.1,4.6c-2.2,1.8-5.1,2.8-8.2,2.8c-0.5,0-1.1,0-1.6-0.1c2.9,1.9,6.4,2.9,10.1,2.9c12.1,0,18.7-10,18.7-18.7 c0-0.3,0-0.6,0-0.8C46,24.5,47.1,23.4,48,22.1z" fill="white"></path></svg></button><button aria-label="linkedin" class="react-share__ShareButton mx-4" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="40" height="40"><circle cx="32" cy="32" r="31" fill="#007fb1"></circle><path d="M20.4,44h5.4V26.6h-5.4V44z M23.1,18c-1.7,0-3.1,1.4-3.1,3.1c0,1.7,1.4,3.1,3.1,3.1 c1.7,0,3.1-1.4,3.1-3.1C26.2,19.4,24.8,18,23.1,18z M39.5,26.2c-2.6,0-4.4,1.4-5.1,2.8h-0.1v-2.4h-5.2V44h5.4v-8.6 c0-2.3,0.4-4.5,3.2-4.5c2.8,0,2.8,2.6,2.8,4.6V44H46v-9.5C46,29.8,45,26.2,39.5,26.2z" fill="white"></path></svg></button><button aria-label="weibo" class="react-share__ShareButton mx-4" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="40" height="40"><circle cx="32" cy="32" r="31" fill="#CD201F"></circle><path d="M40.9756152,15.0217119 C40.5000732,15.0546301 39.9999314,15.1204666 39.5325878,15.2192213 C38.6634928,15.4085016 38.0977589,16.2643757 38.2863368,17.1284787 C38.4667163,18.0008129 39.3194143,18.5686519 40.1885094,18.3793715 C42.8613908,17.8115326 45.7720411,18.6427174 47.7316073,20.8153207 C49.6911735,22.996153 50.2077122,25.975254 49.3714112,28.5840234 C49.1008441,29.4316684 49.5763861,30.3533789 50.4208857,30.6249537 C51.2653852,30.8965286 52.1754769,30.4192153 52.4542425,29.5715703 C53.6349013,25.9011885 52.9133876,21.7699494 50.1585171,18.7085538 C48.0923641,16.4042776 45.2063093,15.1533848 42.3530505,15.0217119 C41.8775084,14.9970227 41.4511594,14.9887937 40.9756152,15.0217119 Z M27.9227762,19.8277737 C24.9957268,20.140498 20.863421,22.4365431 17.2312548,26.0822378 C13.2711279,30.0571148 11,34.2871065 11,37.9328012 C11,44.9032373 19.8713401,49.125 28.5786978,49.125 C39.9917329,49.125 47.600423,42.4261409 47.600423,37.1427636 C47.600423,33.9496952 44.9603397,32.1638816 42.549827,31.4149913 C41.9594976,31.2339421 41.5167516,31.1434164 41.8283133,30.3616079 C42.5006339,28.66632 42.6236176,27.1932286 41.8939054,26.1480742 C40.5328692,24.1894405 36.7203236,24.2881952 32.448635,26.0822378 C32.448635,26.0822378 31.1203949,26.6912261 31.4647526,25.6213825 C32.1206742,23.4981576 32.0304845,21.712342 31.0056075,20.6836478 C30.2840938,19.9512176 29.2510184,19.6878718 27.9227762,19.8277737 Z M42.0906819,20.6836478 C41.6233383,20.6589586 41.1723917,20.716566 40.7132466,20.8153207 C39.9671353,20.9716828 39.4997917,21.7781784 39.6637721,22.5270687 C39.8277525,23.275959 40.5574647,23.7450433 41.303576,23.5804521 C42.1972686,23.3911718 43.2057485,23.6380596 43.8616701,24.3704897 C44.5175916,25.1029198 44.6733735,26.0657797 44.3864073,26.9381118 C44.1486363,27.6705419 44.5093932,28.4770397 45.2391054,28.7156963 C45.9688176,28.9461239 46.780521,28.5922524 47.0100936,27.8598223 C47.584026,26.0740087 47.2396661,24.0248493 45.8950269,22.5270687 C44.886547,21.4078489 43.4845162,20.7494842 42.0906819,20.6836478 Z M29.496988,29.9665891 C35.3100922,30.1723275 39.9917329,33.0691319 40.3852858,37.0769272 C40.8362324,41.6607904 35.5970585,45.9319315 28.6442899,46.6232144 C21.6915214,47.3144973 15.6488446,44.154347 15.197898,39.5787128 C14.7469514,34.9948495 20.059916,30.7237084 27.004486,30.0324256 C27.8735831,29.950131 28.6688875,29.9336709 29.496988,29.9665891 Z M25.5614586,34.3776322 C23.183744,34.5916017 20.9372116,35.9577073 19.9205332,37.9328012 C18.5348994,40.6238672 19.9041362,43.6029661 23.0689567,44.582284 C26.340366,45.5945202 30.1857056,44.0638213 31.5303448,41.1587879 C32.8503864,38.3195909 31.1613894,35.3734082 27.9227762,34.5751416 C27.1438688,34.3776322 26.356763,34.3035667 25.5614586,34.3776322 Z M24.052839,38.7228388 C24.3316067,38.7310678 24.5857748,38.8215935 24.8399449,38.9203482 C25.8648218,39.3400561 26.1845841,40.4428158 25.5614586,41.4221338 C24.9219361,42.3932227 23.5690963,42.8623069 22.5442194,42.4096807 C21.5357395,41.9652856 21.2487754,40.8542948 21.8882979,39.9078951 C22.3638421,39.2001542 23.2247386,38.7146097 24.052839,38.7228388 Z" fill="white"></path></svg></button></div></div><div><hr class="border-theme-line mt-6 mb-6"/><div class="flex leading-6 font-medium text-lg"><a class="flex mr-8 transition-colors duration-200 text-theme-link hover:text-theme-link-highlight" href="/posts/2017-10-30-nested-ienumerator"><span aria-hidden="true" class="mr-2">←</span>Previous Post</a><a class="flex text-right ml-auto transition-colors duration-200 text-theme-link hover:text-theme-link-highlight" href="/posts/2017-11-8-unity-script-manipulation">Next Post<span aria-hidden="true" class="ml-2">→</span></a></div></div><div><hr class="border-theme-line mt-6 mb-6"/><div shortname="https-imagicbell-github-io" config="[object Object]" id="disqus_thread"></div></div></div><div class="max-w-5xl mx-auto"><div><hr class="border-theme-line mt-6 mb-6"/><div class="pt-4 pb-6"><h2 class="text-xl font-medium leading-tight md:leading-none mb-6 text-center">MORE FROM THE BLOG</h2><div class="grid grid-flow-row grid-cols-2 grid-rows-2 lg:grid-cols-4 lg:grid-rows-1 gap-4"><div class="relative h-60 border rounded border-theme-border cursor-pointer hover:shadow-md p-2"><div class="absolute left-0 top-0 w-full h-24 bg-theme-bg"></div><div class="relative h-20 mb-2 overflow-hidden"><p class="absolute bottom-0 text-lg text-left font-medium">Automatic Chain&#x27;s Animation On wheel...</p></div><div class="overflow-hidden h-24"><div class="markdown-body markdown-styles_markdown__1x9gM"><p>In last blog, I introduced the construction of the chains on wheels. This blog will tell the animation calculations. The...</p></div></div><div class="text-xs text-theme-meta absolute bottom-2 flex flex-col sm:flex-row sm:items-center"><time dateTime="2018-06-10T16:00:00+08:00">June	10, 2018</time><div class="w-px h-px border rounded mx-2 border-theme-meta hidden sm:block"></div><span>3min read</span></div><a class="absolute top-0 left-0 w-full h-full" href="/posts/2018-6-10-chain-animation-on-wheels"></a></div><div class="relative h-60 border rounded border-theme-border cursor-pointer hover:shadow-md p-2"><div class="absolute left-0 top-0 w-full h-24 bg-theme-bg"><img src="/blog/assets/img-auto-draw-chain/3.jpg" alt="" class="object-cover w-full h-full" loading="lazy"/></div><div class="relative h-20 mb-2 overflow-hidden"><p class="absolute bottom-0 text-lg text-left font-medium">Automatic Chain&#x27;s Construction On wheel...</p></div><div class="overflow-hidden h-24"><div class="markdown-body markdown-styles_markdown__1x9gM"><p>Rencently I did have fun with a project which I'd like to share. It is to construct a chain automatically...</p></div></div><div class="text-xs text-theme-meta absolute bottom-2 flex flex-col sm:flex-row sm:items-center"><time dateTime="2018-06-07T16:00:00+08:00">June	7, 2018</time><div class="w-px h-px border rounded mx-2 border-theme-meta hidden sm:block"></div><span>2min read</span></div><a class="absolute top-0 left-0 w-full h-full" href="/posts/2018-6-7-auto-draw-chain-on-wheels"></a></div><div class="relative h-60 border rounded border-theme-border cursor-pointer hover:shadow-md p-2"><div class="absolute left-0 top-0 w-full h-24 bg-theme-bg"></div><div class="relative h-20 mb-2 overflow-hidden"><p class="absolute bottom-0 text-lg text-left font-medium">Use Thread In Unity</p></div><div class="overflow-hidden h-24"><div class="markdown-body markdown-styles_markdown__1x9gM"><p>It's been a long time since my last blog, as I've recently spent plenty of time to save a dying...</p></div></div><div class="text-xs text-theme-meta absolute bottom-2 flex flex-col sm:flex-row sm:items-center"><time dateTime="2018-03-31T13:00:00+08:00">March	31, 2018</time><div class="w-px h-px border rounded mx-2 border-theme-meta hidden sm:block"></div><span>2min read</span></div><a class="absolute top-0 left-0 w-full h-full" href="/posts/2018-3-31-thread-in-unity"></a></div><div class="relative h-60 border rounded border-theme-border cursor-pointer hover:shadow-md p-2"><div class="absolute left-0 top-0 w-full h-24 bg-theme-bg"><img src="/blog/assets/img-orthographic-camera/1.JPG" alt="" class="object-cover w-full h-full" loading="lazy"/></div><div class="relative h-20 mb-2 overflow-hidden"><p class="absolute bottom-0 text-lg text-left font-medium">Restrict Object In Specified Screen...</p></div><div class="overflow-hidden h-24"><div class="markdown-body markdown-styles_markdown__1x9gM"><p>I’ve encountered a problem to adjust the position of orthographic camera for restricting 3D objects in the specified rectangle area...</p></div></div><div class="text-xs text-theme-meta absolute bottom-2 flex flex-col sm:flex-row sm:items-center"><time dateTime="2018-01-20T15:00:00+08:00">January	20, 2018</time><div class="w-px h-px border rounded mx-2 border-theme-meta hidden sm:block"></div><span>3min read</span></div><a class="absolute top-0 left-0 w-full h-full" href="/posts/2018-1-20-orthographic-camera-computing"></a></div></div></div></div></div></div></div></main></div><footer class="w-full bg-theme-bg-strong px-container py-4 text-theme-bg-strong-text flex flex-col items-center"><nav class="text-base md:text-lg flex justify-end items-center"><a class="border-b-2 border-theme-bg-strong-text border-opacity-0 hover:border-opacity-100 mx-2 md:mx-4" href="/">Home</a><a class="border-b-2 border-theme-bg-strong-text border-opacity-0 hover:border-opacity-100 mx-2 md:mx-4" href="/blog">Blog</a><a class="border-b-2 border-theme-bg-strong-text border-opacity-0 hover:border-opacity-100 mx-2 md:mx-4" href="/resume">Resume</a></nav><div class="w-full my-2 flex flex-col sm:flex-row justify-between"><div class="text-xs">© 2021 Ling Mao. Powered by <a class="hover:underline" href="https://reactjs.org/" rel="nofollow">React</a> &amp; <a class="hover:underline" href="https://nextjs.org/" rel="nofollow">Next.js</a>.</div><div class="flex justify-center sm:justify-end items-center"><a href="mailto:sophieml1989@gmail.com" class="mr-4"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="envelope" class="svg-inline--fa fa-envelope fa-w-16 h-6" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" color="#fff"><path fill="currentColor" d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path></svg></a><a href="https://www.linkedin.com/in/magicbell" class="mr-4"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="linkedin-in" class="svg-inline--fa fa-linkedin-in fa-w-14 h-6" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" color="#fff"><path fill="currentColor" d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"></path></svg></a><a href="https://github.com/imagicbell" class="mr-4"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github fa-w-16 h-6" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" color="#fff"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Google Blockly Reimplementation with Unity/C#(4)","date":"2017-10-31T20:00:00+08:00","slug":"2017-10-31-blockly-four","ogImage":"/blog/assets/img-blockly/Demo.png","categories":["Unity"],"readTime":8,"content":"\u003ch2 id=\"section-contents\"\u003eContents\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003e\u003ca href=\"/posts/2017-10-11-blockly-one\" rel=\"noopener noreferrer\" target=\"_blank\"\u003eIntroduction\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"/posts/2017-10-14-blockly-two\" rel=\"noopener noreferrer\" target=\"_blank\"\u003eBlockly Model\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"/posts/2017-10-22-blockly-three\" rel=\"noopener noreferrer\" target=\"_blank\"\u003eCode Generator, Interpreter and Runner\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eUGUI Design\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\n\u003ch2 id=\"section-ugui-design\"\u003eUGUI Design\u003c/h2\u003e\n\u003cp\u003e在设计Blockly UI时，主要考虑解决以下几个问题：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003ca id=\"q1\"\u003e\u003c/a\u003e自动生成Block View，可以在Editor里预生成Prefab，也可以Runtime时动态生成GameObject。\u003c/li\u003e\n\u003cli\u003e\u003ca id=\"q2\"\u003e\u003c/a\u003e动态Layout，根据Block View的实际计算大小，以及View之间的相互连接，实现动态布局、缩放。\u003c/li\u003e\n\u003cli\u003e\u003ca id=\"q3\"\u003e\u003c/a\u003e动态Layout后，Block View底图的实时绘制。\u003c/li\u003e\n\u003cli\u003e\u003ca id=\"q4\"\u003e\u003c/a\u003e独立Blockly Model模块，采用观察者模式监听Model的变化。\u003c/li\u003e\n\u003cli\u003e\u003ca id=\"q5\"\u003e\u003c/a\u003eBlock View最近连接的搜索。\u003c/li\u003e\n\u003cli\u003e\u003ca id=\"q6\"\u003e\u003c/a\u003e可重建Workspace，可复制Block View，可变形Block View。\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"section-hierarchy-of-views\"\u003eHierarchy of Views\u003c/h3\u003e\n\u003cp\u003e首先，需要设计一套View Hierarchy，既能符合Block Model的结构，表现Blocks之间的Connection，又能结合UGUI Transform Hierarchy，实现动态Layout计算。\u003c/p\u003e\n\u003cp\u003e回顾\u003ca href=\"/posts/2017-10-14-blockly-two#block\" rel=\"noopener noreferrer\" target=\"_blank\"\u003e讲解Block Model的章节\u003c/a\u003e中关于Block Hierarchy的介绍，可知Block包括Connections、Inputs，而Inputs包括Fields、Connections，Connections可以连接其他Blocks，这些元素均需在UI上体现出来。在此基础上，我们还增加了一个LineGroup，因为某些Block View需要将Inputs分布在多行，LineGroup是用来包裹一行的Inputs。因此，最终的\u003ca id=\"view-hierarchy\"\u003eView Hierarchy\u003c/a\u003e如下：\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003ehierarchy of view:\n\n- Block\n  - ConnectionOutput\n  - ConnectionPrev  \n  - ConnectionNext\n    - Block(Next)\n\n  - LineGroup\n    - Input\n      - Field \n      - Field \n      ...\n      - ConnectionInput\n        - Block(Input)\n    - Input\n      ...\n  - LineGroup\n    ...\n  ...\n- Block\n  ... \u003c/code\u003e\u003c/pre\u003e\n\u003ch4 id=\"section-抽象基类baseview\"\u003e抽象基类BaseView\u003c/h4\u003e\n\u003cp\u003eHierarchy中的每一个元素，都是一个View，因此我们抽象了基类\u003ccode\u003eBaseView\u003c/code\u003e，它继承\u003ccode\u003eMonoBehaviour\u003c/code\u003e，管理了：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e链式结构：Parent, Childs, Previous, Next。\u003c/li\u003e\n\u003cli\u003e自下而上的迭代式Layout Update，\u003ca href=\"#layout-example1\"\u003e详见这里\u003c/a\u003e。\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"section-子类views类型\"\u003e子类Views类型\u003c/h4\u003e\n\u003cp\u003e依据\u003ca href=\"#view-hierarchy\"\u003eHierarchy\u003c/a\u003e，设计了6个基本的View类型：\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eBlockView\u003c/code\u003e, \u003ccode\u003eConnectionView\u003c/code\u003e, \u003ccode\u003eLineGroupView\u003c/code\u003e, \u003ccode\u003eInputView\u003c/code\u003e,\u003ccode\u003eFieldView\u003c/code\u003e, \u003ccode\u003eConnectionInputView\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e其中ConnectionInputView继承自ConnectionView，在Model中都体现为Connection，但在UI表现上ConnectionInputView是包裹输入Block的，而ConnectionView是挂载Next Block。\u003c/p\u003e\n\u003cp\u003e基于这样的设计，可以很好的解决问题\u003ca href=\"#q1\"\u003e1\u003c/a\u003e、\u003ca href=\"#q2\"\u003e2\u003c/a\u003e、\u003ca href=\"#q3\"\u003e3\u003c/a\u003e。\u003c/p\u003e\n\u003ch3 id=\"section-auto-build-block-view\"\u003eAuto Build Block View\u003c/h3\u003e\n\u003cp\u003e无论是Editor预生成Prefab，还是Runtime动态生成，Block View是依赖于Block Model来生成的。依照自上而下的顺序依次创建：\u003c/p\u003e\n\u003cp\u003e\u003cem\u003eBlock\u003c/em\u003e -\u0026gt; \u003cem\u003eConnection, LineGroup\u003c/em\u003e -\u0026gt; \u003cem\u003eInput\u003c/em\u003e -\u0026gt; \u003cem\u003eField\u003c/em\u003e \u003c/p\u003e\n\u003cp\u003e并且同时设置好链式关系，通过\u003ccode\u003eMonoBehaviour\u003c/code\u003e序列化保存下来。\u003c/p\u003e\n\u003ch3 id=\"section-dynamic-layout\"\u003eDynamic Layout\u003c/h3\u003e\n\u003cp\u003e为什么需要Dynamic Layout，它需要做什么？先看下面两个例子：\u003c/p\u003e\n\u003cp\u003e\u003ca id=\"layout-example1\"\u003e例1\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/blog/assets/img-blockly/Layout_1.png\" alt=\"\"\u003e -\u0026gt; \u003cimg src=\"/blog/assets/img-blockly/Layout_2.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca id=\"layout-example2\"\u003e例2\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/blog/assets/img-blockly/Layout_3.png\" alt=\"\"\u003e -\u0026gt; \u003cimg src=\"/blog/assets/img-blockly/Layout_4.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e可以看出：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eBlock的Size会根据其自身Fields大小，以及其Child Blocks大小进行缩放；\u003c/li\u003e\n\u003cli\u003eBlock自身Fields的起始位置，以及Blocks相互之间的起始位置，都会根据缩放后的大小进行重新摆放；\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e因此经过Dynamic Layout之后，布局更紧凑，更美观！那么如何实现的？\u003c/p\u003e\n\u003cp\u003eUGUI有一套Layout机制，是依赖于Transform Hierarchy，在每一个生命周期的Update之后统一计算的，先后不可控，因此无法根据View的依赖关系按照正确的顺序计算。\u003c/p\u003e\n\u003cp\u003e什么是正确的顺序？四个字概括：自下而上。依赖已经建立好的\u003ca href=\"#view-hierarchy\"\u003eHierarchy\u003c/a\u003e，先从最小的元素Fields开始，计算起始位置和大小，然后遍历Next，依次叠加大小来计算起始位置，然后Parent，迭代下去，直到结束。代码大致如下：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"c# language-c#\"\u003eVector2 newSize = CalculateSize();\nif (XY != startPos) XY = startPos;\nif (Size != newSize) Size = newSize;\n\nswitch (Type)\n{\n    case ViewType.Field:\n    case ViewType.Input:\n    case ViewType.ConnectionInput:\n    case ViewType.LineGroup:\n    {\n        if (m_Next == null)\n        {\n            //reach the last child, or no change in current hierarchy, update it's parent view\n            m_Parent.UpdateLayout(m_Parent.SiblingIndex == 0 ? m_Parent.HeaderXY : m_Parent.XY);\n        }\n        else\n        {\n            //update next\n            if (Type != ViewType.LineGroup)\n            {\n                // same line\n                startPos.x += Size.x + BlockViewSettings.Get().ContentSpace.x;\n            }\n            else\n            {\n                // start a new line\n                startPos.y -= Size.y + BlockViewSettings.Get().ContentSpace.y;\n            }\n\n            BaseView topmostChild = m_Next.GetTopmostChild();\n            if (topmostChild != m_Next)\n            {\n                //need to update from its topmost child\n                m_Next.XY = startPos;\n                topmostChild.UpdateLayout(topmostChild.HeaderXY);\n            }\n            else\n            {\n                m_Next.UpdateLayout(startPos);\n            }\n        }\n        break;\n    }\n    case ViewType.Connection:\n    case ViewType.Block:\n    {\n        //no need to update its m_Next, as it is handled by Unity's Transform autolayout \n        //update its parent directly\n        if (m_Parent != null)\n        {\n            m_Parent.UpdateLayout(m_Parent.SiblingIndex == 0 ? m_Parent.HeaderXY : m_Parent.XY);\n        }\n        break;\n    }\n}\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"section-custom-background-draw\"\u003eCustom Background Draw\u003c/h3\u003e\n\u003cp\u003e动态Layout之后，带来的就是底图的实时绘制，当然采用了九宫格的方式，但是简单的九宫格缩放不能满足需求，看这个：\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/blog/assets/img-blockly/Layout_5.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e而这里只用了一张原图：\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/blog/assets/img-blockly/Layout_6.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e当然颜色是自定义设置的，通过UGUI Image面板设置。\u003c/p\u003e\n\u003cp\u003e其实方法很简单，参照UGUI中绘制\u003ccode\u003eImage\u003c/code\u003e的方法，重载\u003ccode\u003eOnPopulateMesh(VertexHelper)\u003c/code\u003e方法，按照九宫格的方式设置好顶点、uv，即可：\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/blog/assets/img-blockly/Layout_7.png\" alt=\"\"\u003e  -\u0026gt;  \u003cimg src=\"/blog/assets/img-blockly/Layout_8.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e上图用圆点标记的，是由外部Layout计算好之后的每一个LineGroup的顶点min, max。分析与代码详见\u003ca href=\"/posts/2017-12-1-unity-image-manipulation\" rel=\"noopener noreferrer\" target=\"_blank\"\u003e这篇\u003c/a\u003e。\u003c/p\u003e\n\u003cp\u003e动态绘制底图还有一个好处是：不需要拼接图片，减少了资源量，并且避免了Draw Call的增加。\u003c/p\u003e\n\u003ch3 id=\"section-observer-pattern\"\u003eObserver Pattern\u003c/h3\u003e\n\u003cp\u003e因为一开始设计的初衷是Model模块完全独立于另外两个模块Interpreter、UI，如果想要移植，完全可以以Model为核心，重新设计这两个模块。因此需要实现Model模块的完全解耦，而Google Blockly Web版是将UI与Model耦合在一起了，也许并不需要考虑移植。\u003c/p\u003e\n\u003cp\u003e观察者模式，是实现UI与Model之间通信的最好方式，Model是事件的发布者，是任何变化、计算的核心，而UI是监听者，监听Model的变化更新表现，以及将用户输入转化为通知Model变化的信号。\u003c/p\u003e\n\u003cp\u003e这是个经典的设计模式，在此不再赘述。\u003c/p\u003e\n\u003ch3 id=\"section-binary-search-nearest\"\u003eBinary Search Nearest\u003c/h3\u003e\n\u003cp\u003e搜索最近连接，如果全局遍历所有的Connection Point，时间复杂度为\u003cem\u003eO(n)\u003c/em\u003e，并且需要计算距离进行比对，无疑是一项耗cpu的操作。所幸的是Google Blockly提供了一套算法方案，二分搜索法。\u003c/p\u003e\n\u003cp\u003e二分搜索法的前提是，有序序列，因此需要对Workspace中的所有Connection Point进行排列。做法是：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e基于Point的\u003ccode\u003ey\u003c/code\u003e坐标，维护一个有序的Connection Point Map。\u003c/li\u003e\n\u003cli\u003e每当Block改变时（增、删、移动），将其Connection Point插入到Map中合适的位置，这个位置也是通过二分搜索法查找，只考虑\u003ccode\u003ey\u003c/code\u003e坐标。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e当要搜索Connection时，先通过\u003ccode\u003ey\u003c/code\u003e坐标找到其在Map中的位置，然后向两边查找。时间复杂度为\u003cem\u003eO(logn)\u003c/em\u003e。\u003c/p\u003e\n\u003cp\u003e当要搜索最近Connection时，也是先通过\u003ccode\u003ey\u003c/code\u003e坐标找到其在Map中的位置，然后向两边通过比对距离来查找，也考虑Connection的兼容性（例如：数学运算符两边只允许数字输入）。时间复杂度为\u003cem\u003eO(logn)\u003c/em\u003e，并且也平均减少了计算量。\u003c/p\u003e\n\u003ch3 id=\"section-manipulate-views\"\u003eManipulate Views\u003c/h3\u003e\n\u003cp\u003e基于以上，操作Block View就变得很方便，因为自动化，动态，并且极大程度的优化了性能。\u003c/p\u003e\n\u003ch4 id=\"section-重建workspace\"\u003e重建Workspace\u003c/h4\u003e\n\u003cp\u003eModel层可以将Workspace保存为Xml文件，Xml文件可以再重建Workspace（见\u003ca href=\"/posts/2017-10-14-blockly-two#workspace_xml\" rel=\"noopener noreferrer\" target=\"_blank\"\u003e前文\u003c/a\u003e）。通过Workspace中Block Models，可以动态创建Block Views，并依据Connections，以及顶层Blocks的位置，实现自动Layout。\u003c/p\u003e\n\u003ch4 id=\"section-复制block-view\"\u003e复制Block View\u003c/h4\u003e\n\u003cp\u003eWorkspace可以保存为Xml文件，当然是基于Block可以保存为一个Xml Node，因此复制Block可以通过将原Block保存为Xml Node，然后从Xml Node重建一个新的Block，再通过Block动态创建Block View。\u003c/p\u003e\n\u003ch4 id=\"section-变形block-view\"\u003e变形Block View\u003c/h4\u003e\n\u003cp\u003eBlock具有\u003ca href=\"/posts/2017-10-14-blockly-two#section-mutation特性\" rel=\"noopener noreferrer\" target=\"_blank\"\u003eMutation特性\u003c/a\u003e，可以动态修改Block结构，因此动态生成Block View的功能为此提供了便利，可以动态增删Input Views。\u003c/p\u003e\n\u003cp\u003eUI部分还有很多可以优化，暂时先介绍这么多。当然如果有更好的设计方案，也欢迎指出，互相学习～\u003c/p\u003e"},"postNav":{"previous":"/posts/2017-10-30-nested-ienumerator","next":"/posts/2017-11-8-unity-script-manipulation"},"morePosts":[{"slug":"2018-6-10-chain-animation-on-wheels","title":"Automatic Chain's Animation On wheel Models","date":"2018-06-10T16:00:00+08:00","locale":"en","readTime":3,"excerpt":"\u003cp\u003eIn last blog, I introduced the construction of the chains on wheels. This blog will tell the animation calculations. The...\u003c/p\u003e"},{"slug":"2018-6-7-auto-draw-chain-on-wheels","title":"Automatic Chain's Construction On wheel Models","date":"2018-06-07T16:00:00+08:00","locale":"en","ogImage":"/blog/assets/img-auto-draw-chain/3.jpg","readTime":2,"excerpt":"\u003cp\u003eRencently I did have fun with a project which I'd like to share. It is to construct a chain automatically...\u003c/p\u003e"},{"slug":"2018-3-31-thread-in-unity","title":"Use Thread In Unity","date":"2018-03-31T13:00:00+08:00","locale":"en","readTime":2,"excerpt":"\u003cp\u003eIt's been a long time since my last blog, as I've recently spent plenty of time to save a dying...\u003c/p\u003e"},{"slug":"2018-1-20-orthographic-camera-computing","title":"Restrict Object In Specified Screen Area Using Orthographic Camera","date":"2018-01-20T15:00:00+08:00","locale":"en","ogImage":"/blog/assets/img-orthographic-camera/1.JPG","readTime":3,"excerpt":"\u003cp\u003eI’ve encountered a problem to adjust the position of orthographic camera for restricting 3D objects in the specified rectangle area...\u003c/p\u003e"}]},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"2017-10-31-blockly-four"},"buildId":"SnMkXRgSjB967-2Ooa8VT","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-ef3d50462330da67074a.js"></script><script src="/_next/static/chunks/main-e903dbcb0f26f07bddca.js" async=""></script><script src="/_next/static/chunks/webpack-245f049e565ebf942e09.js" async=""></script><script src="/_next/static/chunks/framework.29f9e2f3d4a33bafbaa5.js" async=""></script><script src="/_next/static/chunks/commons.449049b2eba38352d9f4.js" async=""></script><script src="/_next/static/chunks/pages/_app-8c930b98cabfdb7a913b.js" async=""></script><script src="/_next/static/chunks/cb1608f2.16ad8215560a85b40620.js" async=""></script><script src="/_next/static/chunks/a9a7754c.dec6fcf45fa1bcf7c2c8.js" async=""></script><script src="/_next/static/chunks/eda77bfa782fcce19c31e9417d5ccf0cdb548971.a781f33eec1afd4f91b3.js" async=""></script><script src="/_next/static/chunks/8410e8da63518be12bbb03b338cbeeeaa2b87d98.22e74b4b4510f82d44b7.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-a69c9fc3973d7a021c84.js" async=""></script><script src="/_next/static/SnMkXRgSjB967-2Ooa8VT/_buildManifest.js" async=""></script><script src="/_next/static/SnMkXRgSjB967-2Ooa8VT/_ssgManifest.js" async=""></script></body></html>