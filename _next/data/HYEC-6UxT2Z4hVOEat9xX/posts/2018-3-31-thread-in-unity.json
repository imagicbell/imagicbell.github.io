{"pageProps":{"post":{"title":"Use Thread In Unity","date":"2018-03-31T13:00:00+08:00","slug":"2018-3-31-thread-in-unity","categories":["Unity"],"readTime":2,"content":"<p>It's been a long time since my last blog, as I've recently spent plenty of time to save a dying project that my ex-colleague left. When confronted with a file transferring bug, I found some essential caveats in Thead usage in Unity. </p>\n<p>As we all know that, Unity has its own main thread, where all its lifecycle functions and features are been executed. In early time, we were told not to use <strong>thread</strong>, but <strong>coroutine</strong> as much as possible, because Unity is not thread-safe. However, coroutine can't always play the role whereas it runs at specific period during the lifecycle in main thread. Consider the scenario of those executions blocking the thread. If we do the socket connecting in main thread, the app will be stuck. So we should feel free to use thread correctly and safely in Unity.</p>\n<p>The bug I fixed was about stopping the thread. I found that calling <code>Thread.Abort()</code> to stop the previous thread and <code>Thread.Start()</code> to start a new thread with the same task function afterwards will cause unexpected results in the variables in the task function. </p>\n<pre><code class=\"c# language-c#\">Thread taskThread;\n\nvoid Task()\n{\n  //do something, and have local variables.\n  while(true)\n  {\n    //...\n  }\n}\n\nvoid StartTask()\n{\n  if (taskThread != null &amp;&amp; taskThread.IsAlive)\n    taskThread.Abort();\n  taskThread = new Thread(Task);\n  taskThread.Start();\n  //there appears some unexpected results in local variables in Task()\n}\n\n//called somewhere in Unity's monobehavior\nStartTask();</code></pre>\n<p>Maybe I should wait a while to check <code>Thread.IsAlive</code> after calling <code>Thread.Abort()</code>. But there is a <a href=\"https://social.msdn.microsoft.com/Forums/en-US/e3e443e1-09a0-435a-8124-6fc19d9bd759/best-way-to-stop-a-thread?forum=csharpgeneral\" rel=\"noopener noreferrer\" target=\"_blank\">best way to stop the thread</a>. Set a boolean flag! Calling <code>Thread.Abort()</code> may throw a <code>ThreadAbortException</code> exceptions. So my solution is as below:</p>\n<pre><code class=\"c# language-c#\">bool runThread = false;\nThread taskThread;\nCoroutine startTaskCoroutine;\n\nvoid Task()\n{\n  //do something, and have local variables.\n  while(runThread)\n  {\n    //...\n  }\n}\n\nIEnumerator StartTask()\n{\n  runThread = false;\n  while(taskThread != null &amp;&amp; taskThread.IsAlive)\n      yield return null;\n\n  runThread = true;\n  taskThread = new Thread(Task);\n  taskThread.Start();\n}\n\n//called somewhere in Unity's monobehavior\nif (startTaskCoroutine != null)\n  StopCoroutine(startTaskCoroutine);\nstartTaskCoroutine = StartCoroutine(StartTask());</code></pre>\n<h3 id=\"section-conclusion\">Conclusion</h3>\n<ul>\n<li>When should we use <strong>thread</strong> instead of <strong>coroutine</strong>?<ol>\n<li>Executions blocking the main thread.</li>\n<li>Complicated calculations that could be run in background.</li>\n<li>Communications with a native code plugin without Unity APIs.</li></ol></li>\n<li>What the caveats are?<ol>\n<li>Avoid Unity APIs in custom threads.</li>\n<li>Use boolean flag to stop the thread instead of <code>Thread.Abort()</code>.</li>\n<li>Be attention with the usage of <a href=\"https://www.cnblogs.com/lionwang/p/4643706.html\" rel=\"noopener noreferrer\" target=\"_blank\"><code>lock()</code></a>.</li></ol></li>\n</ul>"},"postNav":{"previous":"/posts/2018-1-30-css-classname-react-bootstrap","next":"/posts/2018-6-7-auto-draw-chain-on-wheels"},"morePosts":[{"slug":"2021-6-13-ublockly-ugui","title":"The UGUI Design of uBlockly - Reimplementation of Google Blockly in Unity","date":"2021-06-13T20:00:00+08:00","locale":"en","ogImage":"/blog/assets/img-blockly/Demo.png","readTime":5,"excerpt":"<p>For Chinese:...</p>"},{"slug":"2021-6-12-ublockly-interpreter-runner","title":"The Interpreter and Runner of uBlockly - Reimplementation of Google Blockly in Unity","date":"2021-06-12T11:00:00+08:00","locale":"en","ogImage":"/blog/assets/img-blockly/Demo.png","readTime":6,"excerpt":"<p>For Chinese:...</p>"},{"slug":"2021-6-11-ublockly-model","title":"The Blockly Model of uBlockly - Reimplementation of Google Blockly in Unity","date":"2021-06-11T20:00:00+08:00","locale":"en","ogImage":"/blog/assets/img-blockly/Demo.png","readTime":4,"excerpt":"<p>For Chinese:...</p>"},{"slug":"2021-6-10-ublockly-introduction","title":"Introduction of uBlockly - Reimplementation of Google Blockly in Unity","date":"2021-06-10T20:00:00+08:00","locale":"en","ogImage":"/blog/assets/img-blockly/Demo.png","readTime":1,"excerpt":"<p>For Chinese:...</p>"}]},"__N_SSG":true}