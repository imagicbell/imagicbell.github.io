{"pageProps":{"post":{"title":"A Simple Piano App Developed By Tonejs","date":"2019-06-15T10:00:00+08:00","slug":"2019-6-15-piano-app","description":"Use React and Tonejs to develop a simple piano app.","ogImage":"/blog/assets/img-piano/1.jpg","categories":["Front-End"],"readTime":5,"content":"<h3 id=\"section-motivation\">Motivation</h3>\n<p>When I was pregnant, my husband bought me a piano, because he wanted us and our baby to learn piano together. Hmmâ€¦ a good point:)</p>\n<p>But I found it difficult to find a free app that teaches me how to play. Most of the sheet music that I love are in-app purchases. So I decided to make a simple app to help myself read sheet and play piano.</p>\n<p><a href=\"https://github.com/imagicbell/piano-app\" rel=\"noopener noreferrer\" target=\"_blank\">GitHub link</a>.</p>\n<h3 id=\"section-a-glance\">A Glance</h3>\n<p><img loading=\"lazy\" src=\"/blog/assets/img-piano/1.jpg\" alt=\"\"></p>\n<p><img loading=\"lazy\" src=\"/blog/assets/img-piano/2.jpg\" alt=\"\"></p>\n<p>This is how it looks. </p>\n<ul>\n<li>The white and black keys on the piano can be clicked to play.</li>\n<li>It supports two types of music files: MIDI and MusicXML. Also it outputs the parsed json content of the music files.</li>\n<li>It provides a simple play control, including play, pause, resume, step forward and backward, as well as the playback speed.</li>\n</ul>\n<h3 id=\"section-deep-into-the-main-features\">Deep Into The Main Features</h3>\n<h4 id=\"section-1-the-keyboard-interface\">1. The Keyboard Interface</h4>\n<p>This little virtual keyboard is simply created by css styles, calculating the position and color of each key. Also bind the click event to each key with a unique identifier. </p>\n<p>In addition, to fullfil autoplay, I use redux state. Connect the key states to the <code>activeKeys</code> in the redux store, which can be updated somewhere else, e.g. the midi player.</p>\n<h4 id=\"section-2-read-music-sheet\">2. Read Music Sheet</h4>\n<p>We support two music file types: MIDI and MusicXML. Reading MIDI files can be simply done using <a href=\"https://github.com/Tonejs/Midi\" rel=\"noopener noreferrer\" target=\"_blank\">tonejs/midi</a>, which provides api to load MIDI files into javascript object, so I can retrieve the information needed to play using Tonejs. </p>\n<p>For MusicXML, I use <a href=\"https://github.com/jnetterf/musicxml-interfaces\" rel=\"noopener noreferrer\" target=\"_blank\">musicxml-interfaces</a>, which helps me to parse alien sheet music into javascript object. The most difficult and time consuming part is then to extract and organise the information needed to play using Tonejs. I checked <a href=\"https://www.musicxml.com/tutorial/\" rel=\"noopener noreferrer\" target=\"_blank\">musicxml docs</a> a lot for understanding what each element in the sheet music means. Maybe now there are many good works out there which can accomplish this task. If you are interested in the detailed implementation, you can reference the musicxml docs and dive deep into my code. I will ignore the illustration here, as it is really a long story.</p>\n<h4 id=\"section-3-display-music-sheet\">3. Display Music Sheet</h4>\n<p>I use <a href=\"https://github.com/opensheetmusicdisplay/opensheetmusicdisplay\" rel=\"noopener noreferrer\" target=\"_blank\">OpenSheetMusicDisplay</a> to render MusicXML sheet music, which is really a wonderful tool. The usage is quite simple. Call the constructor first, and then load the mxl file, which is a promise. Call render function when the promise resolves.</p>\n<pre><code class=\"javascript language-javascript\">componentDidMount() {\n  this.osmd = new OpenSheetMusicDisplay(\"osmd\");\n}\n\ncomponentWillReceiveProps(nextProps: MusicSheetProps) {\n  if (!nextProps.content) {\n    this.osmd.clear();\n    return;\n  }\n  this.osmd.load(nextProps.content).then(\n    () =&gt; {\n      this.osmd.render()\n    }, (e) =&gt; {\n    console.log(\"music sheet load error\\n\", e);\n  });\n}</code></pre>\n<h4 id=\"section-4-play-music\">4. Play Music</h4>\n<p>This is the part of playing with Tonejs. </p>\n<h5 id=\"section-sound-generation\">Sound Generation</h5>\n<p>I chose <a href=\"https://tonejs.github.io/docs/Sampler.html\" rel=\"noopener noreferrer\" target=\"_blank\">Tone.Sampler</a> to generate the piano sounds. I followed the code from <a href=\"https://github.com/nbrosowsky/tonejs-instruments\" rel=\"noopener noreferrer\" target=\"_blank\">tonejs-instruments</a> and only generate a piano sampler that I prefer. Of course we can generate more samplers like violin, bassoon, clarinet, etc, to create a choir!</p>\n<h5 id=\"section-schedule-the-play\">Schedule the Play</h5>\n<p><a href=\"https://tonejs.github.io/docs/Transport\" rel=\"noopener noreferrer\" target=\"_blank\">Tone.Transport</a> is the main timekeeper. It can be started, stopped, paused, and adjusted on the fly. <strong>Adjust</strong> here means we can modify the <strong>bpm</strong>, <strong>time signatures</strong>, etc. Additionally, which I think is the most important is that we can arrange events along the Transport. Thus, we can schedule the timeline of the music sheet in advance, and then call <code>Tone.Transport.start</code> to start playing it. The event is also created using <code>Tone.Event</code>. Below are pieces of code for arranging the timeline.</p>\n<pre><code class=\"javascript language-javascript\">//adjust the bpm on the fly\nmidi.header.tempos.forEach((tempo, tempoIndex) =&gt; {\n  if (tempoIndex === 0) {\n    Tone.Transport.bpm.value = tempo.bpm;\n  } else {\n    const e = new Tone.Event(time =&gt; {\n      Tone.Transport.bpm.value = tempo.bpm;\n      this.setState({ ...this.state, originBpm: tempo.bpm });\n    });\n    e.start(tempo.time);\n    this.noteEvents.push(e);\n  }\n});</code></pre>\n<pre><code class=\"javascript language-javascript\">//arrange the music timeline\nmidi.tracks.forEach((track, trackIndex) =&gt; {\n  const synth = this.pianoSynths[trackIndex];\n  track.notes.forEach((note, noteIndex) =&gt; {\n    const e = new Tone.Event(time =&gt; {\n      synth.triggerAttackRelease(note.name, note.duration, time, note.velocity);\n      this.props.dispatch(triggerKey(note.name, note.duration));\n    });\n    e.start(note.time);\n    this.noteEvents.push(e);\n  });\n});</code></pre>\n<p>If the song is stopped unexpectedly, we should clean the schedule using <code>Tone.Transport.cancel()</code>, which removes scheduled events from the timeline.</p>\n<h5 id=\"section-control-the-play\">Control the Play</h5>\n<p><code>Tone.Transport</code> provides apis for simply controlling the play as belows:</p>\n<pre><code class=\"javascript language-javascript\">switch(eventType) {\n  case \"Play\": \n    Tone.Transport.start();\n    break;\n\n  case \"Pause\":\n    Tone.Transport.pause();\n    break;\n\n  case \"Resume\":\n    Tone.Transport.start();\n    break;\n\n  case \"Stop\":\n    Tone.Transport.stop();\n    break;\n\n  default:\n    break;\n}</code></pre>\n<p>But how to <strong>step forward and backward</strong>. Actually this frustrated me for a while, and at last I came out an idea that was not that perfect in my mind. Unfortunately, Tone didn't provide a straightforward solution. </p>\n<p><img loading=\"lazy\" src=\"/blog/assets/img-piano/3.png\" alt=\"\"></p>\n<p>As we see from the above piece of music, commonly the piano sheet has at least two tracks. So I keep a record of the last played note in each track, so that I can get the next or the previous note of each track. </p>\n<p>For implementing step forward, after I get the next note of each track, I sort both the start point and the end point of all the next notes on the timeline, as below:</p>\n<p><img loading=\"lazy\" src=\"/blog/assets/img-piano/4.jpg\" alt=\"\"></p>\n<p>Then set the <code>Tone.Transport.position</code> at the first start time, which is <em>track1_note1_start</em> here:</p>\n<pre><code class=\"javascript language-javascript\">//start from the nearest next note\nTone.Transport.position = Tone.Time(timeLine[0]).toBarsBeatsSixteenths();</code></pre>\n<p>and pause at the end of the first play duration, which is <em>track1_note1_end</em> here.</p>\n<pre><code class=\"javascript language-javascript\">//pause after the shortest gap\nlet duration = 0;\nfor (let i = 1; i &lt; timeLine.length; i++) {\n  const gap = timeLine[i] - timeLine[0];\n    if ( gap &gt; 0.0001) {\n    duration = gap;\n    break;\n  }\n}\n\nTone.Transport.start();\nTone.Transport.pause(`+${duration}`); </code></pre>\n<p>Dealing with the step backwards is similar, except one tip that <code>Tone.Transport.position</code> should be set at the start point of one note.</p>\n<h3 id=\"section-not-enough-though\">Not Enough Though</h3>\n<p>This tiny app is far away from good enough, although I can use it to read some sheet music and autoplay the music, following with it. Also it inspires me to create a tiny music game, which creates stuff for interaction at the beats. </p>"},"postNav":{"previous":"/posts/2019-4-29-wechatmini","next":"/posts/2019-8-22-pregnancy-delivery"},"morePosts":[{"slug":"2021-6-5-build-my-website-image-opti","title":"How To Build My Own Website (4) - Image Optimization","date":"2021-06-05T20:00:00+08:00","locale":"en","excerpt":"This article illustrates how I applied image optimization to improve the performance of my website.","readTime":0},{"slug":"2021-3-14-build-my-website-style","title":"How To Build My Own Website (3) - Style","date":"2021-03-14T20:00:00+08:00","locale":"en","excerpt":"This article illustrates how I style my own website using Tailwindcss framework, make theme color configurable, and apply interactive animations.","readTime":2},{"slug":"2021-3-12-build-my-website-markdown","title":"How To Build My Own Website (2) - Markdown","date":"2021-03-12T20:00:00+08:00","locale":"en","readTime":3,"excerpt":"<p>Parsing and displaying Markdown files are one of the most important things in building a personal website, because all my...</p>"},{"slug":"2021-3-10-build-my-website-nextjs","title":"How To Build My Own Website (1) - Next.js","date":"2021-03-10T20:00:00+08:00","locale":"en","readTime":5,"excerpt":"<p>I had always dreamed of building my own website, to express myself, to keep memory of what I have done,...</p>"}]},"__N_SSG":true}