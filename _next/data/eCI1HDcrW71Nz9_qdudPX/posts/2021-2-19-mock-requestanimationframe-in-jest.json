{"pageProps":{"post":{"title":"Mock requestAnimationFrame in Jest","date":"2021-02-19T10:00:00+08:00","slug":"2021-2-19-mock-requestanimationframe-in-jest","categories":["Front-End"],"readTime":1,"content":"<p>When I wrote test for my tiny <a href=\"/posts/2021-1-7-rythm-game\" rel=\"noopener noreferrer\" target=\"_blank\">rhythm game</a>, I realized that all the browser based actions needed to be mocked, including <code>window.requestAnimationFrame</code>. I created a custom hook <code>useCanvas</code> which takes a <code>draw</code> function and renders the content under canvas every frame using <code>requestAnimationFrame</code>. I decided to write a test to test this functionality.</p>\n<pre><code class=\"javascript language-javascript\">export default function useCanvas(draw) {\n    const canvasRef = useRef(null);\n    const loopId = useRef();\n    const previousTime = useRef();\n\n    useEffect(() =&gt; {\n        const canvas = canvasRef.current;\n        const context = canvas.getContext('2d');\n\n        const loop = time =&gt; {\n            if (previousTime.current) {\n                context.clearRect(0, 0, canvas.width, canvas.height);\n                draw(context, 0.001 * (time - previousTime.current));\n            }\n            previousTime.current = time;\n            loopId.current = requestAnimationFrame(loop);\n        }\n\n        loopId.current = requestAnimationFrame(loop);\n        return () =&gt; cancelAnimationFrame(loopId.current);\n    }, [draw]);\n\n    return canvasRef;\n}</code></pre>\n<p>I searched \"mock requestAnimationFrame\" directly on the Jest doc, but got no hint. Then googled it and got a <a href=\"https://github.com/facebook/jest/issues/5147#issuecomment-353274996\" rel=\"noopener noreferrer\" target=\"_blank\">potential solution</a>:</p>\n<pre><code class=\"javascript language-javascript\">beforeEach(() =&gt; {\n  jest.spyOn(window, 'requestAnimationFrame').mockImplementation(cb =&gt; cb());\n});\n\nafterEach(() =&gt; {\n  window.requestAnimationFrame.mockRestore();\n});</code></pre>\n<p>However, this solution produces infinite call loop, because it calls <code>cb</code> immediately, and then in <code>cb</code> the <code>requestAnimationFrame</code> calls <code>cb</code> again, and againâ€¦ Hm, I realized that it was close. I only needed to fix this issue. How about delaying the call of <code>cb</code>?</p>\n<p>Then <code>setTimeout</code> came to help. But also <code>setTimeout</code> needs to be mocked in Jest to make it move forward. Fortunately, Jest has already worked it out, see <a href=\"https://jestjs.io/docs/en/timer-mocks\" rel=\"noopener noreferrer\" target=\"_blank\">Timer Mocks</a>. So my final solution is:</p>\n<pre><code class=\"javascript language-javascript\">beforeEach(() =&gt; {\n  jest.useFakeTimers();\n\n  let count = 0;\n  jest.spyOn(window, 'requestAnimationFrame').mockImplementation(cb =&gt; setTimeout(() =&gt; cb(100*(++count)), 100));\n});\n\nafterEach(() =&gt; {\n  window.requestAnimationFrame.mockRestore();\n  jest.clearAllTimers();\n});</code></pre>\n<p>Then in test mock the timer:</p>\n<pre><code>act(() =&gt; {\n  jest.advanceTimersByTime(200);\n});</code></pre>\n<p>The <code>100</code> in <code>setTimeout</code> acts like the <code>deltaTime</code> between frames, and can be custom defined. </p>"},"postNav":{"previous":"/posts/2021-1-7-rythm-game","next":"/posts/2021-3-10-build-my-website-nextjs"},"morePosts":[{"slug":"2021-3-14-build-my-website-style","title":"How To Build My Own Website (3) - Style","date":"2021-03-14T20:00:00+08:00","locale":"en","excerpt":"This article illustrates how I style my own website using Tailwindcss framework, make theme color configurable, and apply interactive animations.","readTime":2},{"slug":"2021-3-12-build-my-website-markdown","title":"How To Build My Own Website (2) - Markdown","date":"2021-03-12T20:00:00+08:00","locale":"en","readTime":3,"excerpt":"<p>Parsing and displaying Markdown files are one of the most important things in building a personal website, because all my...</p>"},{"slug":"2021-3-10-build-my-website-nextjs","title":"How To Build My Own Website (1) - Next.js","date":"2021-03-10T20:00:00+08:00","locale":"en","readTime":4,"excerpt":"<p>I had always dreamed of building my own website, to express myself, to keep memory of what I have done,...</p>"},{"slug":"2021-1-7-rythm-game","title":"Create A Classical Rythm Game With React Hooks and Tone.js","date":"2021-01-07T21:00:00+08:00","locale":"en","ogImage":"/blog/assets/img-rythm-game/1.jpg","readTime":5,"excerpt":"<p>Recently I've been obsessed with React Hooks, and then I came up with an idea to create a classical rythm...</p>"}]},"__N_SSG":true}