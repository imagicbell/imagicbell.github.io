{"pageProps":{"post":{"title":"Create A Classical Rythm Game With React Hooks and Tone.js","date":"2021-01-07T21:00:00+08:00","slug":"2021-1-7-rythm-game","ogImage":"/blog/assets/img-rythm-game/1.jpg","categories":["Front-End"],"readTime":5,"content":"<p>Recently I've been obsessed with React Hooks, and then I came up with an idea to create a classical rythm game using Hooks and <a href=\"https://github.com/Tonejs/Tone.js\" rel=\"noopener noreferrer\" target=\"_blank\">Tone.js</a>. This is how it looks:</p>\n<p><img src=\"/blog/assets/img-rythm-game/1.jpg\" alt=\"\"></p>\n<p>Alongside the playing music, drops fall down and we hit the bottom circles to keep up with the rythm. There are several features:</p>\n<ol>\n<li>3 hit results according to the timing: <strong>Perfect</strong>, <strong>Good</strong>, and <strong>Miss</strong>. The <strong>combo</strong> count is recorded.</li>\n<li>Left hand buttons(from left to right): <strong>a</strong>, <strong>s</strong>, <strong>d</strong>. Right hand buttons(from left to right): <strong>j</strong>, <strong>k</strong>, <strong>l</strong>. We can choose to open left, right, or both hand tracks.</li>\n<li>The music can be played, paused, resumed and stopped.</li>\n</ol>\n<p><a href=\"https://github.com/imagicbell/A-Rythm-Game-Created-With-React-Hooks-And-Tonejs\" rel=\"noopener noreferrer\" target=\"_blank\">Github link</a>.</p>\n<p>Below I will illustrate how I created this tiny game using React Hooks and Tone.js.</p>\n<h3 id=\"section-react-hooks\">React Hooks</h3>\n<h4 id=\"section-why-using-hooks\">Why using Hooks?</h4>\n<p>Hooks make it easier to reuse behaviors. We can make custom hooks to share stateful logic between components. In this project, I created a <code>Canvas</code> hook, which accepts <code>draw</code> function and  manages the render loop. In addition, hooks make codes prettier and easier to maintain, compared to those components that started simple but grew into an umanagable mess of stateful logic and side effects. I replaced these classes with functions as much as possible, and it turned out to be really enjoyable. </p>\n<h4 id=\"section-canvas-hook\">Canvas Hook</h4>\n<p>The <code>Canvas</code> hook is mainly in charge of rendering game objects. It takes in the <code>draw</code> function as the only parameter, and uses canvas context to render every frame by <code>requestAnimationFrame</code>. Inside it, we use the <code>Effect</code> hook to register/unregister the <code>requestAnimationFrame</code>, only when the <code>draw</code> function changes(<code>Effect</code> hook re-render dependency). </p>\n<pre><code class=\"javascript language-javascript\">export default function useCanvas(draw) {\n    const canvasRef = useRef(null);\n    const loopId = useRef();\n    const previousTime = useRef();\n\n    useEffect(() =&gt; {\n        const canvas = canvasRef.current;\n        const context = canvas.getContext('2d');\n\n        const loop = time =&gt; {\n            if (previousTime.current) {\n                context.clearRect(0, 0, canvas.width, canvas.height);\n                draw(context, 0.001 * (time - previousTime.current));\n            }\n            previousTime.current = time;\n            loopId.current = requestAnimationFrame(loop);\n        }\n\n        loopId.current = requestAnimationFrame(loop);\n        return () =&gt; cancelAnimationFrame(loopId.current);\n    }, [draw]);\n\n    return canvasRef;\n}</code></pre>\n<p>The usage of Canvas Hook is like this, building a customized Canvas component.</p>\n<pre><code class=\"javascript language-javascript\">export default function Canvas(props) {\n    const { draw, ...restProps } = props;\n    const canvasRef = useCanvas(draw);\n\n    return (\n        &lt;canvas ref={canvasRef} {...restProps} /&gt;\n    )\n}</code></pre>\n<h5 id=\"section-gameloop-hook\">GameLoop Hook</h5>\n<p>Similarly, we can use hooks to create a game loop hook, which updates the game logic every frame.</p>\n<pre><code class=\"javascript language-javascript\">export function useFrameLoop(callback) {\n    const loopId = useRef();\n    const previousTime = useRef();\n\n    const loop = time =&gt; {\n        if (previousTime.current) {\n            callback(0.001 * (time - previousTime.current));    \n        }\n\n        previousTime.current = time;\n        loopId.current = requestAnimationFrame(loop);\n    }\n\n    useEffect(() =&gt; {\n        loopId.current = requestAnimationFrame(loop);\n        return () =&gt; cancelAnimationFrame(loopId.current);\n    }, []);\n}</code></pre>\n<p>I only used the <code>Canvas</code> Hook, because they both use <code>requestAnimationFrame</code> to update frame. I drop both logic and render stuff in the <code>draw</code> function of  <code>Canvas</code> Hook. It is not recommended, but consider it is just a tiny project. </p>\n<h5 id=\"section-choose-canvas-over-svg\">Choose Canvas Over SVG</h5>\n<p>Originally, I used <strong>SVG</strong> to render game objects, as it is the same declarative way as React style. But it turned out to be bad performance when there are many game objects needed to be re-render every frame. The frame rate dropped rapidly. So I move to Canvas, which is game app perferred. The drawback is that I had to adjust the imperative coding style with React. This is also why I use <code>useRef</code> Hook a lot.</p>\n<h4 id=\"section-why-not-using-redux\">Why not using Redux?</h4>\n<p>Originally, I used <strong>Redux</strong> to manage the states of the game objects, e.g. positions of drops. After I turned to use Canvas over SVG, and with the help of <code>useRef</code>,  I found that I can manage the game states in the familiar way as I used to do when developing Unity games. I put the game states in objects, including the updating logic, and then use <code>Ref</code> Hook to keep them.</p>\n<h3 id=\"section-tonejs\">Tone.js</h3>\n<h4 id=\"section-why-using-tonejs\">Why using Tone.js?</h4>\n<p>Previously I created a simple <a href=\"/posts/2019-6-15-piano-app\" rel=\"noopener noreferrer\" target=\"_blank\">Piano App</a> using Tone.js. Tone.js provides optimized features to interact with music. In this rythm game, <a href=\"https://tonejs.github.io/docs/Transport\" rel=\"noopener noreferrer\" target=\"_blank\">Tone.Transport</a> gives a hand. It enables to synchronize music and schedule events along the timeline, which is perfectly what I need. </p>\n<p>The music synchronization:</p>\n<pre><code class=\"javascript language-javascript\">const player = new Tone.Player(`${url}.mp3`).toDestination();\nawait Tone.loaded();\nplayer.sync().start(NOTE_PREVIEW_TIME);        //the parameter is the start position of the music on the timeline.</code></pre>\n<p>With the MIDI JSON object, I scheduled the drop events on the Transport timeline.</p>\n<pre><code class=\"javascript language-javascript\">for (const track of midi.tracks) {\n  for (const note of track.notes) {\n    if (!note.playInfo)\n      continue;\n\n    //preview\n    Tone.Transport.schedule(time =&gt; {\n      if (this.onNotePreview) {\n        Tone.Draw.schedule(() =&gt; {\n          this.onNotePreview(note.playInfo);\n        }, time);\n      }\n    }, note.time);\n  }\n}</code></pre>\n<h5 id=\"section-why-use-tonedrawschedule\">Why use <code>Tone.Draw.schedule()</code>?</h5>\n<p>According to the API doc:</p>\n<blockquote>\n  <p>Draw is useful for synchronizing visuals and audio events. Callbacks from Tone.Transport or any of the Tone.Event classes always happen <em>before</em> the scheduled time and are not synchronized to the animation frame so they are not good for triggering tightly synchronized visuals and sound. Draw makes it easy to schedule callbacks using the AudioContext time and uses requestAnimationFrame. Draw is used to synchronize the draw frame with the Transport's callbacks.</p>\n</blockquote>\n<h4 id=\"section-parse-midi\">Parse MIDI</h4>\n<p>Tone.js also provides a <a href=\"https://github.com/Tonejs/Midi\" rel=\"noopener noreferrer\" target=\"_blank\">friendly tool</a> to convert MIDI into Tone.js-friendly JSON, thus I can read MIDI files and then manipulate the notes as useful input of our rythm game.</p>\n<pre><code class=\"javascript language-javascript\">import { Midi } from '@tonejs/midi';\n\nconst midi = await Midi.fromUrl(url);\nmidi.header.timeSignatures.forEach(ts =&gt; ts.time = midi.header.ticksToSeconds(ts.ticks));\nmidi.header.keySignatures.forEach(ks =&gt; ks.time = midi.header.ticksToSeconds(ks.ticks));\nmidi.tracks.forEach((track, trackId) =&gt; {\n  const lightIdOffset = trackId % 2 === 0 ? LIGHT_NUM / 2 : 0;\n  track.notes.forEach(note =&gt; {\n    let lightId = lightIdOffset + notes.find(n =&gt; n.midi === note.midi).lightId;\n    note.playInfo = {\n      lightId,\n      trackId,\n      playType: note.duration &gt; CLICK_THRESHOLD ? PLAY_TYPE_PRESS : PLAY_TYPE_CLICK,\n      duration: note.duration\n    };\n  });\n});</code></pre>\n<h3 id=\"section-conclusion\">Conclusion</h3>\n<p>This is a demo level of a rythm game created by React Hooks and Tone.js. A real rythm game needs more work, like editing rythm drops to optimize players' experience. Also inspired by this project, a digital piano that has preview drops can be made, just by changing the bottom circles into piano keys.</p>\n<p>A limitation of this project is that we need to provide both the <strong>.mp3</strong> and <strong>.mid</strong> files for one song. <strong>.mp3</strong> for playing music, and <strong>.mid</strong> for scheduling drop events, as Tone.js can't play <strong>.mid</strong>. We can use mp3-mid converter to convert these two files mutually, but the result may not be synced. </p>"},"postNav":{"previous":"/posts/2020-10-7-algorithm-traversal-of-binary-tree","next":"/posts/2021-2-19-mock-requestanimationframe-in-jest"},"morePosts":[{"slug":"2021-3-14-build-my-website-style","title":"How To Build My Own Website (3) - Style","date":"2021-03-14T20:00:00+08:00","locale":"en","excerpt":"This article illustrates how I style my own website using Tailwindcss framework, make theme color configurable, and apply interactive animations.","readTime":2},{"slug":"2021-3-12-build-my-website-markdown","title":"How To Build My Own Website (2) - Markdown","date":"2021-03-12T20:00:00+08:00","locale":"en","readTime":3,"excerpt":"<p>Parsing and displaying Markdown files are one of the most important things in building a personal website, because all my...</p>"},{"slug":"2021-3-10-build-my-website-nextjs","title":"How To Build My Own Website (1) - Next.js","date":"2021-03-10T20:00:00+08:00","locale":"en","readTime":4,"excerpt":"<p>I had always dreamed of building my own website, to express myself, to keep memory of what I have done,...</p>"},{"slug":"2021-2-19-mock-requestanimationframe-in-jest","title":"Mock requestAnimationFrame in Jest","date":"2021-02-19T10:00:00+08:00","locale":"en","readTime":1,"excerpt":"<p>When I wrote test for my tiny rhythm game, I realized that all the browser based actions needed to be...</p>"}]},"__N_SSG":true}